# 6장. 로드 밸런서 / 방화벽 : 4계층 장비(세션 장비)
- 4계층 장비는 2,3계층에서 고려하지 않던 **통신의 방향성, 순서, 등의 통신 전반에 대한 관리가 필요함**
  - 포트 번호, 시퀀스 번호, ACK 번호에 대해 이해해야함

  - 이러한 정보들을 **`세션 테이블`** 에 저장하고 관리해서 사용함
    
## 6.1 4계층 장비의 특징
- 4계층 장비는 TCP와 같은 **4계층 헤더에 있는 정보를 이해하고 이 정보들을 기반으로 동작함**
  - **`세션 장비`** : 로드 밸런서, 방화벽

- 세션 장비는 여러 가지를 고려해야 하는데 우선적으로 다음과 같은 요소를 고려해야함

  **`세션 테이블`**
    - 세션 장비는 세션 테이블 기반으로 운영됩니다.
        
    - 세션 정보를 저장, 확인하는 작업 전반에 대한 이해가 필요합니다.
        
    - 세션 정보는 세션 테이블에 남아 있는 라이프타임이 존재합니다. 이 부분에 대한 고려가 필요합니다.
        
  **`Symmetric(대칭) 경로 요구`**
    - Inbound와 Outbound 경로가 일치해야 합니다.
    
  **`정보 변경(로드 밸런서)`**
    - IP 주소가 변경되며 확장된 L7 로드 밸런서(ADC) 애플리케이션 프로토콜 정보도 변경됩니다.

- 이러한 요소는 서비스에 영향을 주기 때문에 인프라뿐만 아니라 **시스템 설계 및 어플리케이션 개발에서도 세션 장비를 고려** 해야함

## 6.2 로드 밸런서
- **`서버나 장비의 부하 분산을 위해 사용하는 장비`**
  - 4계층 이상에서 동작

  - 트래픽을 분배해주는 기능, IP 주소, 4계층 정보, 애플리케이션 정보를 확인, 수정하는 기능이 있음

  - 웹 서버의 부하 분산 용도로 자주 사용됨

  - 외에도 FWLB, VPNLB와 같은 다양한 서비스를 위해 사용됨

- 대표 IP 주소를 서비스 IP로 사용 → 로드 밸런서가 각 시스템의 실제 IP로 변경해 요청 보냄

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/33749e13-f9f9-48d6-af6c-433f7812fb98)

- 4계층: **`L4 로드 밸런싱`**
  - 일반적인 로드 밸런서가 동작하는 방식
  
  - TCP, UDP 정보(포트 넘버)를 기반으로 로드 밸런싱 수행
      
  - 장비에서 L7 지원 여부와 상관없이 4계층에 대한 정보로만 분산 처리하는 경우
      
- 7계층: **`L7 로드 밸런싱`**
  - HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱 수행
    - HTTP 헤더 정보나 URI와 같은 정보를 기반으로 프로토콜을 이해한 후 부하 분산하기도 함
      
  - `ADC(Application Delivery Controller)` 라고도 부름
    - 프록시(Proxy) 역할 수행
    
    - 스퀴드(Squid)나 Nginx에서 수행하는 리버스 프록시(Reverse Proxy)와 유사한 기능을 가짐

### 6.2.1 L4 스위치
- **`4계층에서 동작하면서 로드 밸런서 기능이 있는 스위치`**
  - 외형은 스위치처럼 여러 포트를 가지며, 로드 밸런서 기능 수행 

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/c0c5df34-ba24-4114-b319-5d361ecfc313)

- 부하 분산, 성능 최적화, 리다이렉션 기능을 제공함

- **`가상 IP를 리얼 IP로 변경해주는 역할`**
  - 사용자는 L4 가상 IP를 목적지로 서비스를 요청, L4 스위치는 가상 IP를 리얼IP로 변경해서 보냄
    - 해당 과정에서 부하를 어떤 방식으로 분산할 지 결정할 수 있음  

  - `가상 서버(Virtual Server)` : 사용자가 바라보는 실제 서비스
    
  - `가상 IP(Virtual IP)` : 사용자가 접근해야 하는 서비스 IP 주소
    
  - `리얼 서버(Real Server)` : 실제 서비스를 수행하는 서버
    
  - `리얼 IP(Real IP)` : 실제 서버의 IP

### 6.2.2 ADC(Application Delivery Controller)
- **`7계층(애플리케이션 계층)에서 동작하는 로드 밸런서`**

- 다양한 부하 분산, 정보 수정, 정보 필터링 가능
  - 이러한 상세한 동작을 위해 프록시로 동작 

- 로드 밸런싱 기능, 페일오버(Failover, 장애극복 기능), 리다이렉션(Redirection) 기능 수행

- 애플리케이션 프로토콜를 이해하고 최적화하는 기능도 제공
  - 캐싱(Caching), 압축(Compression), 콘텐츠 변환 및 재작성, 인코딩 변환, 등

- 플러그인 형태로 보안 강화 기능을 추가할 수도 있음
  - WAF(Web Application Firewall) 기능, HTML, XML 검증 및 변환 수행

### 6.2.3 L4 스위치 vs ADC
- **`L4 스위치`**
  - TCP, UDP 정보 기반으로 부하 분산
    
  - **`TCP 계층에서의 최적화 및 보안 기능`**
    - Dos 방어, TCP 세션 재활용, 등 

  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/6cedd0d9-c881-410d-ae31-533557a6e41a)

- **`ADC`**
  - 애플리케이션 내용에 대한 분산, 리다이렉션, 최적화 제공
    - L4 스위치보다 좀 더 다양한 기능 사용 가능
  
  - **`정적 콘텐츠 캐싱`**

  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/1be5c1f1-34ff-4a0a-a05b-65eaff132934)

  - **`하드웨어 가속 및 소프트웨어 최적화`**
    - 웹서버의 콘테츠 압축 기능을 ADC에서 대신 수행 → 서버의 부하를 줄임

  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/bc542c2d-231f-436c-b069-858c9622d46d)

  - **`SSL 엔드 포인트 동작`** → 클라이언트에서 ADC까지의 구간 SSL로 처리, ADC와 웹 서버 사이 HTTP로 통신
    - 웹 서버 여러대의 SSL통신을 하나의 ADC에서 수용하기 위해 전용 SSL 가속 카드를 ADC에 내장함

  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/a43f1551-c540-46d6-a8d8-71c6d26adb51)

## 시스템 확장 방법 : 스케일 업과 스케일 아웃
- 서비스의 사용자가 증가 → **`시스템 확장`**
  - 스케일 업(Scale-Up)과 스케일 아웃(Scale-Out) 
  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/f3ad6d04-7d1d-4e98-a2b4-2dcc360039a1)

- **`스케일 업(Scale-Up)`** : 새로 더 큰 용량의 시스템을 구매해 서비스를 옮기는 방법
  - 부품을 쉽게 추가
  
  - 시스템 설계 변경 없이 서비스 사용량 증가 가능
  
  - 부품 추가 어려움
  
  - 시스템이 커질수록 비용이 기하급수적으로 증가

  - 확장을 미리 고려해 시스템을 구축하면 초기 비용이 커지고, 현재 서비스에 적합한 시스템을 구매하면 확장시에 기존 시스템 낭비
    - 즉, 유연한 대처가 어려움 
  
  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/55e19678-bab5-44ee-adf0-13f72aa98a3f)

- **`스케일 아웃(Scale-Out)`** : 같은 용량의 시스템을 여러 대 배치
  - 스케일 업 방식보다 더 적은 비용으로 시스템 확장 가능

  - 여러 대의 시스템에 로드를 적절히 분산해 하나의 시스템에 장애 발생 → 결함 허용 구현

  - **별도의 복잡한 아키텍쳐 이해 및 운영**

  - 프로세스나 네트워크 장비 추가 필요

- 시스템 축소도 유사함
  - 스케일 다운(Scale-Down) : 기존 시스템보다 작은 용량의 시스템으로 서비스를 옮기는 방법
  
  - 스케일 인(Scale-In) : 여러 개의 서비스를 합쳐 하나의 시스템에서 운영하는 방법

**`장단점 비교 및 정리`**

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/f2802d35-23af-4d9d-8924-cb00c7768369)

## 6.3 방화벽
- **`네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용(Permit)하거나 차단(Deny)하는 장비`**
  - 네트워크 3, 4계층에서 동작하고 세션을 인지, 관리하는 SPI(Stateful Packet Inspection) 엔진을 기반으로 동작하는 장비

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/4e595800-4261-4296-ac26-096d86263ef4)

- 세션 정보를 장비 내부에 저장

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/9edb1268-05a8-41e8-8a7b-8603132a016a)

- 세션 테이블을 이용해 패킷의 인과 관계를 파악 → 정책을 손쉽게 유지함
  - 패킷이 외부에서 처음 시작했는지. 내부 사용자가 외부에 요청한 응답인지,등을 가려냄

## 6.4 4계층 장비를 통과할 때의 유의점(세션 관리)
- 세션 장비 → 세션을 이해하고 세션 테이블 유지

- 세션 테이블 정보를 활용하여 패킷을 변경하거나 애플리케이션 성능 최적화, 보안 강화 → 패킷 포워드 및 드롭
  - 기능을 잘 활용하기 위해 세션 정보를 동일하게 유지하거나, 어플리케이션에서 여러 기능을 추가해주어야함
  
- **`애플리케이션의 세션 시간과 서비스 방향성 고려, 비대칭 경로 회피`**
  - 대부분의 문제는 이런 부분을 고려하지 않아서 발생 

### 6.4.1 세션 테이블 유지, 세션 정보 동기화
- 통신 시작시 세션 장비는 해당 세션의 상태를 테이블에 기록
  - 일정 시간(세션 타임아웃)만 정보를 저장 → 효율적인 메모리 관리 및 악의적인 공격 방지 

- 세션 장비의 타임아웃 값이 애플리케이션 타임아웃 값보다 짧으면 통신에 문제가 생김
  - 정보 불일치로 인해 중간에서 막힐 수 있음

- 이러한 문제를 해결하기 위해 각각(세션 장비 및 어플리케이션) 적용할 수 있는 설정이 있음
  
**`동작 순서`**

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/dce76756-269e-4fcb-bfb5-c310ef7307ac)

1. 3방향 핸드셰이크를 통해 정상적으로 세션 설정
    - ⓵ 방화벽에서 세션 설정 과정을 확인하고 세션 테이블 기록

2. ⓶, ⓷ 세션 테이블을 참조해 방화벽에서 패킷 통과

3. 일정 시간 동안 통신 없음

4. ⓸ 세션 타임으로 세션 테이블 만료

5. 세션 만료 후 애플리케이션 통신 시작

6. ⓹ 세션이 만료되어 방화벽에서 패킷 드롭


#### 6.4.1.1 세션 장비 운영자 입장
- **`세션 만료 시간 증가`**
  - 애플리케이션의 세션 유지 시간보다 방화벽 세션 유지 시작이 길어야 함

  - 애플리케이션 고유의 세션 유지 시간 **미리 공지**
     
- **`세션 시간을 둔 채로 중간 패킷을 수용할 수 있도록 방화벽 설정(세션 장비 중 방화벽에 해당)`**
  - 세션 테이블에 정보가 없는 ACK 패킷이 들어오더라도 세션을 새로 만들어 통과시킬 수 있는 옵션

  - 전체적인 보안이 취약해지기 때문에 가능하면 적용하지 않는 것이 좋음 

- **`세션 장비에서 세션 타임아웃 시 양 단말에 세션 종료 통보`**
  - 양 종단 장비의 세션 정보와 중간 세션 장비의 세션 정보가 일치하지 않아 발생하는 문제를 해결하기 위해 사용
  
  - 세션 타임아웃 시 세션 정보를 삭제하는 것이 아니라 세션 정보에 있는 양 종단 장비에 세션 정보 만료(RST) 통보

**`세션 만료 시 동작 과정`**

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/57e8efd8-556f-4a37-ae61-4cd7fe5fc4d2)

1. 세션 설정

2. 일정 시간 동안 통신 없음

3. ⓵ 세션 타임아웃값이 넘어 세션 만료

4. ⓶ 방화벽에서 양 종단 장비에 RST 패킷 전송
    - A,B 장비 통신일 경우
  
    - A 장비에는 출발지 B, 도착지 A인 RST 패킷 전송
  
    - B 장비에는 출발지 A, 도착지 B인 RST 패킷 전송

5. RST 패킷을 받은 양 종단 장비는 해당 프로세스 종료

#### 6.4.1.2 개발자 입장
- **`애플리케이션에서 주기적인 패킷 발생 기능 추가`**
  - 중간에 통신이 없더라도 일정 시간마다 양 단말 애플리케이션의 세션 상태 정보를 체크하는 더미 패킷(Dummy Packet)을 보내는 기능

  - 더미 패킷을 주기적으로 보내거나 트래픽이 일정 시간 동안 없을 때만 더미 패킷을 보내거나 더 복잡한 로직을 이용해 애플리케이션 상태를 체크하는 기능 구현

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/b1341497-8642-4f1e-9edb-f9b0134c2ce8)

### 6.4.2 비대칭 경로 문제
- 네트워크를 이중화하게 되면 패킷이 지나가는 경로가 2개 이상이므로 인바운드 패킷과 아웃바운드 패킷이 같거나 다를 수 있음
  - **`대칭 경로(Symmetric Path)`** : 인바운드 패킷과 아웃바운드 패킷이 같은 장비를 통과
  
  - **`비대칭 경로(Asymmetric Path)`** : 인바운드 패킷과 아웃바운드 패킷이 다른 장비 통과

  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/e6e17d8d-ed35-492a-a52a-cb637af4665d)

- 세션 테이블을 만들어 관리하기 위해서는 동일한 장비를 통과해야함
  - 경로가 일정하게 유지되지 않으면 정상적인 서비스가 되지 않음 

  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/30cbd18a-6377-4fb4-b82a-f5a241db463c)

  - 가장 좋은 해결 방법은 비대칭 경로가 생기지 않도록 하는 것

  - 만약, 비대칭 경로가 생긴다면 적절한 조치를 취해주어야 함 

- **`세션 테이블 동기화`**

  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/65b88bfc-5c1f-4faa-9ebd-b333fd17de30)

  - 패킷 경로를 변경하지 않고 동작

  - 세션 동기화하는 시간보다 패킷 응답이 빠르면 정상적으로 동작 불가능

  - 응답시간이 비교적 긴 인터넷 게이트웨이로 방화벽 사용 시 사용
  
- **`세션 장비에서 다양한 방법으로 보정`**

  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/d3a143d1-e60d-4ef5-94ab-6c38f4a83c10)
 
  - 다른 세션 장비 쪽으로 패킷을 보내 경로 보정
  
    - **`MAC 리라이팅`** : 강제로 다른 방화벽으로 패킷을 보내기 위해 방화벽 간 통신용 링크 필요, MAC 주소 변경
  
    - **`터널링`** : 기존 패킷에 MAC 주소를 한 번 더 인캡슐레이션

### 6.4.3 하나의 통신에 두 개 이상의 세션이 사용될 때의 고려사항
- 특별한 목적으로 두 개 이상의 세션을 만드는 경우가 있음 
  - 이때, 서로 다른 두 세션이 하나의 통신을 위해 사용하고 있다는 것을 네트워크 통신 중간에 놓인 세션 장비도 파악해야 함

- **`프로토콜의 구분`**
  - **`데이터 프로토콜`** : 데이터를 실어 나름
  
  - **`컨트롤 프로토콜`** : 데이터가 잘 전송되도록 세션 제어

  - 현대 프로토콜들은 대부분 하나의 프로토콜에서 헤더나 별도 메시지로 처리하지만, 간혹 특별한 목적으로 나누어져 있는 경우도 있음

- **`FTP(File Transfer Protocol)`** : 파일 전송 프로토콜
  - 네트워크 상에서 컴퓨터들이 파일을 교환하기 위해 사용

  - 컨트롤 프로토콜과 데이터 프로토콜 완전히 분리, 통신 방법이 다른 두 가지 모드 사용

  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/4f05a2de-9a5a-492d-b961-fbaff6d026f3)

  - **`Active 모드`**
    - 명령어를 전달하는 컨트롤 프로토콜과 데이터를 전달하는 데이터 프로토콜이 분리, 방향도 반대로 동작

    - 컨트롤 프로토콜은 클라이언트에서 서버로 통신 시작

    - 데이터 프로토콜은 서버에서 클라이언트 쪽으로 데이터 푸시

    - ALG(Application Layer Gateway) : FTP가 동작하는 프로토콜을 모두 이해할 수 있는 별도 기능 동작

    ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/4735d28e-ed5f-4679-88a1-d1addc7fe069)

  - **`Passive 모드`**
    - 컨트롤, 데이터 프로토콜이 분리되어 있는 것은 같음, 클라이언트에서 서버쪽으로 데이터를 요청해 다운받도록 동작

    - FTP 서버에서 Passive 모드에서 사용하는 데이터 포트의 범위 설정 가능

    ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/7f77f9da-4903-4bfb-930e-f4f475b25213)
