# 6장

IP 부족으로 NAT 기술, 방화벽, 프록시 같은 장비들이 등장하며 4계층 장비도 네트워크 장비에 포함되었다.

기존 2, 3 계층 장비가 고려하지 않았던, 방향성이나 순서를 관리하는데 이를 세션테이블에 담아 관리한다.

# 4계층 장비의 특징

4계층 장비는 TCP와 같은 4계층 헤더 정보를 이해하고 동작한다.

4계층 장비가 2, 3계층과 다른점은 **세션 테이블**과 **세션 정보**가 가장 중요하다고 할 수 있다.

세션을 기반으로 동작하는 방화벽, NAT, 로드 밸런서같은 장비가 있으면 시스템 설계, 애플리케이션 개발에도 세션 장비에 대한 고려가 필요하다.

세션 테이블 : 세션 정보를 저장, 확인한다.  이때 세션 정보에는 life time이 존재한다.

대칭 경로 요구 : Inbound와 Outbound 경로가 일치해야한다.

정보 변경 : IP 주소가 변경되며 확장된 L7 로드 밸런서는 애플리케이션 프로토콜 정보도 변경된다.

# 로드 밸런서

서버나 장비의 **부하를 분산**하기 위해 사용되는 장비이다. 4계층 7계층에서 동작하며 IP 주소나 4계층 정보, 애플리케이션 정보를 확인/수정 한다.

스케일 업보다 스케일 아웃을 선호하는데, 장비가 여러대여도 하나의 서비스로 보여야 하기 때문에 로드 밸런서가 서비스의 대표 IP를 갖고 각 시스템으로 분산한다.

L4 로드 밸런싱

TCP, UDP 정보를 기반으로 로드 밸런싱 수행

L7 로드 밸런싱

HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱 수행

HTTP 헤더나, URI같은 정보를 기반으로 프로토콜 이해 후 부하 분산. 일반적으로 ADC라고 부르며 프록시 역할 수행한다. 스퀴드나 Nginx에서의 리버스 프록시와 비슷한 기능.

* 데이터 센터에서는 L4, L7 모두 지원하며 설정에 따라 작동 방식이 나뉘지만, 클라우드에서는 컴포넌트를 계층별로 구분해 사용한다. (AWS기준 L4 = NLB, L7=ALB)

### L4 스위치

4계층에서 동작하며 로드 밸런싱 기능이 있다. 여러가지 로드 밸런서중 가장 대중화 되어있으며, **부하 분산, 성능 최적화, 리다이렉션** 기능 제공.

L4 스위치가 동작하려면 가상서버, 가상IP, 리얼 서버, 리얼 IP를 설정해야 하는데, 가상 서버는 사용자가 바라보는 실제 서비스를 뜻하고, 가상 IP는 사용자가 접근하는 서비스 주소이다. 리얼 서버는 실제 서비스를 수행하고, 리얼 IP는 실제 서버의 IP이다. L4스위치는 가상IP를 리얼 IP로 변경해주는 역할을 한다.

### ADC

애플리케이션 계층에서 동작하는 로드밸런서로 L4와 달리 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작하여 다양한 **부하 분산, 정보 수정/필터링이** 가능하다. **프록시**로 동작한다.

대부분의 ADC는 L4 스위치의 기능(페일오버, 리다이렉션)을 포함한다. 이 외에도 **캐싱, 압축, 콘텐츠 변환/재작성, 인코딩 변환**등이 가능하고 애플리케이션 **프로토콜을 최적화** 하기도 한다.

플러그인 형태로 보안 기능을 추가해 WAF나, HTML, XML 검증과 변환을 수행하기도 한다.

### L4 스위치 vs ADC

L4 스위치

TCP, UDP 정보를 기반으로 부하 분산 및 TCP 최적화 및 보안기능 제공.

TCP의 간단한 DoS 공격 방어 및 TCP 세션 재사용 가능.

ADC

애플리케이션 내용 분산, 리다이렉션, 최적화등 L4보다 다양한 기능

이미지나, 정적 콘텐츠 캐싱 가능. → 웹 서버 부하 줄임

SSL 엔드포인트로 동작하기 때문에 SSL 전용 카드 내장.

* 스케일 업과 아웃

보통 스케일 업보다 아웃이 저렴해 스케일 아웃 하고 로드 밸런서를 사용한다는건 많이 알고있는 사실이다.

트래픽이 줄때는 어떻게 하는게 좋을까? 작은 용량으로 줄이는 방법을 스케일 다운, 서버 대수를 줄이는 방법을 스케일 인이라고 하는데 이 방법도 스케일 업/아웃과 장단점이 연결된다.

# 방화벽

네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 정책에 따라 허용하거나 차단하는 장비.

일반적으로 3, 4 계층에서 동작하고 세션을 인지하는 SPI 엔진을 기반으로 동작한다.

NAT 방식과 유사하게 세션 정보를 내부에 저장하여, 외부로 나갔던 세션 정보를 저장하고 들어오는 패킷을 가려낸다. 만약 이런 세션 정보를 저장하는 세션 테이블이 없다면 매우 복잡한 정책관리를 해야할 것이다.

# 4계층 장비를 통과할 때 유의점

세션 장비는 일반적인 2, 3 계층 네트워크 장비와 달리 세션을 이해하고 세션 테이블을 유지한다.

보안 강화 및 애플리케이션 성능 최적화를 위해 패킷을 포워드/드롭할 수 있다. 이 기능을 충분히 활용하기 위해선 **세션 장비 간 정보를 동일**하게 유지해야 한다. 특히 **비대칭 경로를 피하는 것**이 좋은데 대부분의 문제는 이 부분을 고려하지 않아서 발생한다.

### 세션 테이블 유지

세션 테이블은 메모리에 저장되기 때문에 일정 시간만 정보를 저장한다.  악의적인 사용자가 세션 공격을 하는 경우 타임 아웃 값을 더 줄이기도 한다. 타임 아웃 값을 조정할 때 장비의 타임 아웃 값이 애플리케이션의 타임 아웃 값보다 짧아지면 통신 중간에 세션 테이블에 정보가 사라져 패킷을 차단해 문제가 생긴다.

이런 경우 문제를 해결하는 방법이 있다.

**세션 장비 관리자**

- 세션 만료 시간 증가
    
    애플리케이션 세션 만료 시간에 맞게 만료 시간을 늘린다. 이때 방화벽 세션 유지 시간이 애플리케이션 세션 유지 시간보다 길어야 한다.
    
- 세션 시간을 둔 채로 패킷을 수용할 수 있도록 방화벽 설정
    
    세션 테이블에 정보가 없는 ACK 패킷이 들어오면 세션을 새로 만들어 통과시키는 방법.
    
    이 방법은 보안이 취약해진다.
    
- 세션 장비에서 세션 타임아웃 시 양 단말에 세션 종료 통보
    
    양 종단 장비의 세션 정보와 중간 장비의 세션 정보가 일치하지 않아 생기는 문제이다.
    
    따라서, 세션 타임 아웃시 세션을 삭제하지 않고, 양 종단 장비에 세션 만료를 통보하여 새로운 세션을 맺도록 한다.
    

**개발자**

- 애플리케이션에서 주기적인 패킷 발갱 기능 추가
    
    더미 패킷을 보내어 세션 타임아웃이 발생하기 전에 세션을 유지시킨다.
    

### 비대칭 경로 문제

인바운드와 아웃바운드 패킷이 다른 장비를 통과하는 경우를 비대칭 경로라고 한다.

세션 테이블을 만들어 관리해야 하는데, 인바운드와 아웃바운드 경로가 다르면 정상적인 서비스가 되지 않는다.

**최고의 방법은 예방**이다. 비대칭 경로가 생기지 않도록 네트워크와 경로 디자인을 하는 것이다.

**나머지 방법**

- 세션 테이블 동기화
    
    두 개 경로사의 장비가 하나의 장비처럼 동작하도록 동기화 한다. 이때, 세션 동기화 시간보다 패킷 응답이 빠르면 문제가 발생한다. 비교적 긴 인터넷 게이트웨이로 방화벽이 사용될때 사용해보자.
    
- 비대칭 경로 보정
    
    강제로 대칭 경로를 만들어 인바운드와 아웃바운드 패킷이 동일한 장비를 통과하도록 한다.
    
    방화벽 통신 링크가 필요하며 MAC 리라이팅이나 터널링 기법을 사용한다.
    

### 하나의 통신에 두 개 이상의 세션이 사용될 때 고려사항

특별한 목적으로 하나의 통신에서 두 세션을 사용하기도 하는데, 이를 네트워크 중간의 세션 장비도 알아야 한다.

두 통신중 한 쪽 세션이 끊어지거나, 세션 테이블에서 삭제되면 단방향 통신만 가능하거나, 통신이 불가능해질 수 있기 때문이다.

데이터 프로토콜 : 데이터를 실어 나른다.

컨트롤 프로토콜 : 데이터가 잘 전송되도록 세션을 제어한다.

현대 프로토콜은 대부분 데이터와 컨트롤 프로토콜 기능을 모두 하나의 프로콜에서 헤더나 별도의 메세지로 해결하지만, 특별한 목적이나 오래된 프로토콜은 분리되어 있다.(FTP)

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/f58a9178-eb34-436a-a9fc-a8c49a91710b)

FTP의 기본 구동 방식은 Active이다. 

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/3dd0879e-0ab5-45d2-b073-84597ef2e687)

이와 같이 다른 포트를 사용하여 데이터를 주고받는다.

중간에 방화벽이나 세션 장비가 있으면 Active 동작에 맞추어 방화벽의 반대 방향도 열어주어야 한다.

특히 NAT 환경인 경우 FTP가 동작하는 프로토콜을 모두 이해할 수 있는 별도 기능(ALG)을 동작시켜야 한다.

ALG : 방화벽이 FTP 명령어를 이해하고 반대 방향으로 시작하는 데이터 세션을 인지해 방화벽과 NAT를 자동으로 동작한다.

Passive 방법은 Active 방법의 단점인 프로토콜 방향이 반대인 점을 보완하여 만들어졌다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/6df8d754-3955-415e-9787-32208308b38b)

이 방법은 클라이언트 쪽에 방화벽이나 세션 장비가 있는 경우 특별한 장비 없이 동작한다.

하지만 서버 쪽에 방화벽이 있으면, 데이터를 다운로드 하기 위해 추가 포트를 열어줘야 한다.
