# 11장 이중화 기술

안정적인 무중단 서비스를 제공하기 위해선 이중화 기술이 필수인데, 네트워크의 이중화에 대해 알아보자

# 이중화 기술 개요

### SPoF (Single Point of Failure)

단일 장애점 : 시스템 구성 요소중 동작하지 않으면 전체 시스템이 중단되는 요소(장비)를 뜻한다.

가용성 높은 인프라 서비스를 위해선 SPoF를 만들지 않아야 한다.

### 이중화의 목적

안정적인 서비스를 위해 인프라를 구성하는 각 요소가 복수개 이상으로 구성되어야 한다.

→ 서비스에 필요한 출발 지점부터 끝 지점까지 모든 인프라에 이중화 구성을 고려해야 한다. (네트워크 인터페이스, 스위치, L4/L7 스위치, 방화벽, 게이트웨이등등) 

그리고 데이터 센터까지 이중화 한다.(액티브-액티브, 액티브-스탠바이) 스패닝 트리가 액티브 - 스탠바이에 속한다.

액티브 - 액티브 상태에서 이중화된 인프라 모두 요청을 처리하기 때문에 전체 처리 용량이 증가하고 장애가 발생했을때 용량이 절반으로 떨어진다.

# LACP(Link Aggregation Control Protocol)

1997년 연결계층의 표준화가 시작되었는데 그게 바로 LACP이다.

LACP의 목적은 링크 사용률 향상과, 향상된 장애 회복이다.

LACP를 사용하게 되면 두 개 이상의 물리 인터페이스로 구성된 논리 인터페이스를 이용해 모든 물리 인터페이스를 액티브 - 액티브 상태로 사용한다. 이때 일부 인터페이스가 문제가 발생해도 나머지 물리 인터페이스가 서비스를 유지한다.

유의사항

- 물리 인터페이스가 장애가 발생하면 대역폭이 줄어들어 정상적인 서비스를 제공할 수 없다.
- 구성하는 물리 인터페이스들의 속도가 동일해야 한다.

### LACP 동작 방식

LACP 장비간 논리 인터페이스를 구성하기 위해 LACPDU라는 프레임을 사용하는데, LACPDU엔 출발지/목적지 주소와 타입, 서브타입 등을 멀티캐스트로 매초 주고 받는다.

LACPDU를 주고받는 장비는 1:1 구성이어야 하며, LACPDU를 주고받는 모든 장비가 LACP 설정이 되어있어야 한다.

LACP는 두가지 모드가 있는데 보통 액티브 옵션을 사용한다. (패시브 - 패시브 끼리 구성 불가)

액티브 - 선 송신 후 전송

패시브 - 선 수신 후 전송

### LACP와 PXE

두 네트워크 장비 간 LACPDU를 사용해 LACP가 동작하는데 인터페이스를 하나의 논리 포트로 묶는 과정인 본딩/티밍은 OS에서 설정한다.

PXE(Pre-boot eXecution Enviroment)는 OS 설치 전이므로 본딩/티밍 같은 논리 인터페이스는 설정할 수 없다. 따라서, PXE로 OS를 설치할 때는 일반 인터페이스를 사용한 뒤 OS에서 LACP 설정을 해야한다.

1. OS가 없으면 LACP 구성 못해서 PXE로 OS 설치 및 설정함
2. OS에서 LACP 구성함

# 서버의 네트워크 이중화 설정

리눅스에서 인터페이스 이중화 하는 기술을 본딩이라고 한다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/7277abd5-ec18-4b41-a901-f6bf11d4924a)

### 리눅스 본딩 모드

위의 사진처럼 이중화 할때 방법은 0부터 4까지 있는데 1, 4 방법 외엔 잘 사용하지 않는다.

**1 액티브 - 스탠바이** 

액티브가 죽으면 스탠바이가 자동으로 활성화 된다.

액티브가 다시 살아나면 수동으로 넘기기 전까지 스탠바이 인터페이스는 활성화를 유지한다.

**4 LACP**

액티브 - 액티브 방식이다.

### 리눅스 본드 설정 및 확인

Fedora 계열과 Debian 계열로 나뉜다.

**CentOS**

`/etc/sysconfig/network-scripts` 에 설정파일이 존재하며

1. ifcfg-bond0을 생성해 본드 인터페이스를 설정한다.
2. ifcfg-eh0 같이 물리 인터페이스 설정도 같이 해줘야 한다.
3. 설정을 마친 뒤에는 bonding 설정 파일 위치(`/etc/modprobe.d`)로 이동해 속성을 변경한다.
4. 커널에 본드 모듈을 적재한다.

**Ubuntu**

1. ifenslave 패키지를 설치한다.
2. `/etc/modules` 에 bonding 모듈을 추가하고 재시작한다.
3. `/etc/network/interfaces` 에 bond, eh 에 대한 설정을 한다.

# MC-LAG(Multi-Chassis Link Aggregation Group)

LACP - 다수의 물리 인터페이스를 이용해 하나의 논리 인터페이스 구성, 물리 장비 1:1 구성

이 방법은 다일 스위치를 사용해야 하기 때문에 스위치에 장애가 발생하면 서비스에 문제가 생긴다.

MC-LAG를 사용하면 서로 다른 스위치 간에 가상 MAC 주소를 만들어 구성할 수 있다.

따라서 MC-LAG을 사용하면 다양한 구성을 만들 수 있다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/68a73115-46ea-4557-a20d-586d7192694a)

### MC-LAG 동작 방식

벤더마다 다르지만 전체적인 동작 방식은 비슷하다.

Peer 장비 : MC-LAG을 구성하는 장비

MC-LAG 도메인 : Peer 장비를 논리 장비로 구성하기 위한 영역 ID (서로를 인식함)

Peer-Link : Peer 장비간 데이터 트래픽을 전송하는 인터 링크

**동작 순서**

1. Peer에 동일한 도메인 ID 부여
2. Peer-Link 설정
3. Peer 끼리 통신 가능한 IP 설정

**LACP를 통화 이중화 구성**

MC-LAG을 이용해 생성한 MAC 주소를 출발지 주소로 사용한다.

# 게이트웨이 이중화

동일한 서브넷에서 라우터의 도움 없이 직접 통신하는 것을 L2 통신이라 한다.

L2 통신이 아닌 경우 목적지와 통신을 위해 게이트웨이를 이용하는데(L3) 게이트웨이에 문제가 생기면 통신을 할 수 없다.

이때 FHRP를 사용해 게이트웨이를 이중화 할 수 있다.

### FHRP(First Hop Redundancy Protocol)

두개 이상의 라우터의 실제 IP 외에 추가로 가상 IP 주소와 가상 IP 주소에 대한 MAC 주소를 동일하게 갖는다. 그룹 내에선 우선 순위가 높은 장비가 Active가 된다.

프록시 ARP를 사용해 해결하기도 하는데 보안 문제가 있다.

**동작 방식**

1. 각 장비가 동일 그룹으로 인식되기 위해 같은 그룹 ID를 갖는다.
2. 게이트 웨이 주소로 사용할 가상IP를 각 장비에 설정한다. 이때 가상 MAC도 생긴다.
3. 하단 호스트가 가상IP로 ARP 요청을 하게되면 브로드캐스트 되면서 FHRP의 Active장비가 응답한다.

FHRP 그룹의 Active 장비에 장애가 발생하면 Stanby 장비가 Active 역할을 가져와 가상 MAC주소 테이블을 갱신해 자동으로 이관된다.

FHRP의 표준은 VRRP인데 거의 모든 장비가 지원한다. 설정하는 방법을 알아보자.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/8f7a6d32-1427-44d9-ab06-31d62236a158)

1. 해당 장비의 실제 IP 주소를 설정한다.
2. VRID를 설정한다. (한 네트워크 내에 다르게 설정, 1~254)
3. VRRP를 사용해 구성하는 가상 IP 주소를 설정
4. 장비간 우선순위 설정
5. track을 통해 헬스체크하고, 실패하면 정해진 크기만큼 우선순위를 내린다.
6. 스탠바이가 액티브보다 우선순위가 높아지면 자동으로 액티브를 가져오도록 하는 기능

### 올 액티브 게이트웨이 이중화

위의 방법은 액티브 - 스탠바이로 동작하는데, 스탠바이 장비로 요청이 들어 오더라도 액티브를 거쳐야 한다.

매우 비효율적이기 때문에 액티브 - 액티브로 구성하면 더 효율적이다.

### 애니캐스트 게이트웨이

게이트웨이가 한 곳에 위치하게 되면 모든 트래픽이 하나의 게이트웨이를 거쳐 통신하게 되므로 비효율적이다.

애니케스트 게이트웨이를 적용하면 같은 주소를 가지는 게이트웨이가 여러개 동작할 수 있다.

동일한 가상화 서버에서 다른 네트워크 or 스위치를 가지고 있다면 가상화 서버 외부의 게이트웨이를 거쳐야 한다.
