# 7.3 GLSB (Global Server/Service Load Balancing)

* DNS 로드밸런싱 : 동일한 레코드 이름으로 서로 다른 IP 주소를 동시에 설정하여 쿼리에 따라 응답받는 IP 주소를 나누어 로드밸런싱하는것

GSLB는 전통적인 DNS와 같이 동작하며 추가적으로 health check와 active/backup을 지정 가능하게 하여 재해 복구(DR), 지역적인 부하분산, 응답시간 중심의 서비스를 제공 가능하게 할 수 있다.

* 그래서 인텔리전스 DNS라고도 부른다. 

DNS와 동일하게 도메인 질의에 응답해주는 역할과 로드밸런서처럼 등록된 도메인에 연결된 서비스가 정상적인지 헬스 체크를 수행한다.

* 즉, 등록된 도메인에 대한 서비스가 정상인지 상태를 체크해 정상인 레코드에 대해서만 사용

GSLB의 목표로는

- disaster recovery(재난 복구)
  실패에 대해 대체할 수 있는 서버를 제공한다.
- load sharing(부하 분산)
  많은 트래픽을 여러 서버로 분산시킨다.
- performance(성능)
  client의 위치나 네트워크를 기반으로 최적의 성능을 낼 서버를 선택해준다.

가 존재한다. 

### GLSB 동작 방식

<img src="./images//image-20230722171719982.png" width = 800 height = 500>

예 ) 서울과 부산의 데이터 센터에서 동일한 서비스가 가동중인 상황

1. ﻿﻿﻿사용자가 web.zigispace.net에 접속하기 위해 DNS에 질의
2. ﻿﻿﻿LDNS는 web.zigispace.net을 관리하는 NS 서버를 찾기 위해 root부터 순차 질의
   * LDNS : 로컬 DNS
3. ﻿﻿﻿zigispace.net을 관리하는 NS 서버로 web.zigispace.net에 대해 질의.
4. ﻿﻿﻿DNS 서버는 GSLB로 web.zigispace.net에 대해 위임했으므로 GSIB 서버가 NS 서버라고 LDNS에 응답.
5. ﻿﻿﻿LDNS는 다시 GSLB로 web.zigispace.net에 대해 질의.
6. ﻿﻿﻿GSLB는 web.zigispace.net에 대한 IP 주솟값 중 현재 설정된 분산 방식에 따라 서 울 또는 부산 데이터 센터의 IP 주솟값을 DNS에 응답. 
   * 본 예제에서는 서울 데이 터 센터의 서비스 IP인 1.1.1.1을 응답하는 것으로 가정. 
   * GSLB가 응답하는 값은 GSLB에서 설정한 주기에 따라 서울과 부산 데이터 센터로 헬스 체크해 정상적인 값만 응답.
7. ﻿﻿﻿GSLB에서 결과값을 응답받은 LDNS는 사용자에게 wel.zigispace.neto 1.1.1.1로 서비스하고 있다고 최종 응답.



GLSB는 단순히 IP 정소만 가지고 있다 응답해주는것이 아니고 헬스 체크를 통하여 정상 서비스인지 확인한 후 돌려준다.

### GSLB 구성 방식

GLSB를 사용한 도메인 설정 방법은 2가지가 있다.

* 도메인 자체를 GLSB로 사용
* 도메인 내의 특정 레코드만 GLSB를 사용 

## 7.3.3 GSLB 분산 방식

GSLB를 이용하여 서비스를 분산하면 다음과 같은 목적을 달성할 수 있다.

- ﻿﻿서비스 제공의 가능 여부를 체크해 트래픽 분산
- ﻿﻿지리적으로 멀리 떨어진 다른 데이터 센터에 트래픽 분산
- ﻿﻿지역적으로 가까운 서비스에 접속해 더 빠른 서비스 제공이 가능하도록 분산

서비스 헬스 체크 외에도 트래픽을 다른 사이트로 분산시키는 다양한 서비스 분산 방식을 지원한다.

대부분 다음 두가지 헬스 체크 모니터링 요소를 지원한다

* 서비스 응답 시간/지연(RTT/Latency) : 서비스 요청에 대한 얼마나 빠른지, 지연이 없는지를 확인하여 분산처리
* IP에 대한 지리 정보 : Ip주소에 대한 GeoMetery 값을 확인해 가까운 사이트로 서비스 분산처리

**궁극적인 목표 : 트래픽을 분산하고, 더 신속하고 안정적인 서비스를 유도하는것이 목표**

# 7.4 DHCP

DHCP (Dynamic Host Configuration Protocal) : IP를 동적으로 할당하는데 사용되는 프로토콜

DHCP를 사용하면IP주소, 서브넷마스크, 게이트웨이 DNS 정보를 자동으로 할당받아서 별도의 IP 설정 작업이 필요 없어

사용자와 관리자 모두 편하게 네트워크에 접속할 수 있다.

사용하지 않는 IP 정보는 회수되고, 사용하는 경우에만 재할당되어서 `사용자 이동이 많고 한정된 IP 주소를 가진 경우 유용하게 사용될 수 있다.`

**DHCP의 주요 목적**

1. **IP 주소 관리 간소화**: DHCP를 사용하면, 네트워크 관리자는 각 클라이언트에게 수동으로 IP 주소를 할당하거나 추적할 필요가 없습니다. 대신 DHCP 서버는 IP 주소 풀(pool)을 관리하고, 클라이언트 요청에 따라 자동으로 IP 주소를 할당합니다.
2. **IP 주소 재사용**: DHCP는 IP 주소의 재사용을 가능하게 합니다. 클라이언트가 네트워크를 떠나면, 해당 클라이언트에게 할당되었던 IP 주소는 DHCP 서버에 의해 회수되어 다른 클라이언트에게 재할당 될 수 있습니다.
3. **네트워크 설정 오류 감소**: 수동 IP 주소 구성의 경우, 주소 충돌 또는 잘못된 구성으로 인한 문제가 발생할 수 있습니다. DHCP를 사용하면, 이러한 오류를 크게 줄일 수 있습니다.
4. **네트워크 변경 관리 용이**: DHCP를 사용하면 네트워크 설정 변경이 필요할 때 일괄적으로 관리할 수 있습니다. 예를 들어, DNS 서버 IP가 변경되었을 때, 각 클라이언트를 개별적으로 수정하는 대신 DHCP 서버 설정만 변경하면 됩니다.



우리가 사용하는 클라우드에서 언제 사용되냐면

**클라우드 컴퓨팅 및 가상화 환경**: 클라우드 서비스 제공자는 DHCP를 사용하여 가상 머신에 동적으로 IP 주소를 할당한다. 

## DHCP 프로토콜

DHCP는 BOOTP(Bootstrap Protocal)을 기반으로 한다

* BOOTP와 유사하지만 확장된 프로토콜이다

* DHCP와 BOOTP는 호환성이 있다.

DHCP는 서버와 클라이언트로 동작하며 클라이언트의 서비스 포트는 68, 서버의 서비스 포트는 67이다

DHCP 프로토콜에 대한 자세한 내용은 RFC 2131(https://tools.ietf.org/html/rfc2131) 에 있다

### DHCP 동작 방식

호스트가 자동으로 IP를 할당받는 과정을 보자

호스트가 DHCP 서버로 IP를 할당받는 과정은 다음과 같이 4단계로 진행된다

<img src="./images//image-20230723155007413.png" width = 800 height = 500>

1. ﻿﻿﻿**DHCP Discover(탐색 메시지)** : DHCP 클라이언트는 DHCP 서버를 찾기 위해 **DHCP Discover 메시지**를 **브로드캐스트**로 전송.
   * DHCP 클라이언트의 IP가 없으므로 출발지 IP는 0.0.0.0 목적지는 브로드캐스트 주소인 255.255.255.255
   * 서비스 포트는 출발지가 UDP 68, 목적지는 UDP 67번 포트 - IP를 할당받는 과정이므로 패킷을 주고받을 수 없어 UDP 사용
2. ﻿﻿﻿**DHCP Offer** : DHCP Discover를 수신한 DHCP 서버는 클라이언트에 할당할 IP 주소와 서브넷, 게이트웨이, DNS 정보, Lease Time 등의 정보를 포함한 DHCP 메시지(이메시지가 DHCP Offer 메시지)를 클라이언트로 전송
   * 클라이언트로부터 메시지를 받으면 서버는 할당할 수 있는 IP를 할당
3. ﻿﻿﻿**DHCP Request** :  DHCP 서버로부터 제안받은 IP 주소(Requested IP)와 DHCP 서버 정보(DHCP Server identifier)를 포함한 DHCP 요청 메시지를 브로드캐스트로 전송.
   * 이때도 DHCP 서버가 어느 서버인지 알 수 없으므로 브로드 캐스트로 전송한다 
   * DHCP Offer 메시지에 자신이 제안한  IP 주소를 사용하는지 여부를 확인할 수 있으므로 그것을 확인하여 해당 패킷에만 응답한다. 
4. ﻿﻿﻿**DHCP Acknowledgement(ACK)** : DHCP 클라이언트로부터 IP 주소를 사용하겠다는 요청을 받으면, DHCP 서버에 해당 IP를 어떤 클라이언트가 언제부터 사용하기 시작했는지 정보를 기록하고 DHCP Request 메시지를 정상적으로 수신했다는 응답을 전송.



DHCP Offer에서 Lease Time(임대 시간)에 대한 정보를 준다고 했다.

임대 시간이 다 지나면 클라의 IP는 수거되어 사용되지 모샇므로 갱신이 필요하다

<img src="./images//image-20230723160053098.png" width = 750 height = 400>

임대 시간(Lease Time)이 50%가 지나면 DHCP 갱신 과정을 수행한다.

1. DHCP Request를 전송
   * 임대 과정과 달리 이미 사용중인  IP 정보가 있으므로 DHCP Discover와 DHCP Offer 과정을 생략한다.
   * 임대 과정과 달리 브로드 캐스트가 아닌 유니캐스트로 진행한다
2. 초기 갱신에 실패하면, 임대시간의 75%가 지났을 경우 다시 갱신을 시도한다. 
   * 이때도 갱신에 실패하면 추가 갱신 없이 임대 시간이 모두 지난 후 IP를 반납하고, 처음부터 임대 과정을 거쳐 IP를 할당받게 된다.



> 

**DHCP 메시지 타입**

| 메시지 타입                         | 내용                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| DHCP Discover                       | 클라이언트가 DHCP 서버를 찾는 메시지                         |
| DHCP Offer                          | DHCP 서버가 IP 설정값에 대해 클라이언트에게 제안하는 메시지  |
| DHCP Request                        | 클라이언트가 DHCP 서버에서 제안받은 설정값을 요청하는 메시지 |
| DHCP Decline                        | 클라이언트가 이미 사용 중인 IP를 받았음을 DHCP 서버에 알려주는 메시지 |
| DHCP Ack                            | DHCP 서버가 클라이언트의 요청을 수락하고, 네트워크 설정을 보내주는 메시지 |
| DHCP Nak (Negative Acknowledgement) | DHCP 서버가 클라이언트의 요청을 수락하지 않는다는 메시지     |
| DHCP Release                        | 클라이언트가 현재 할당받은 IP 주소를 반납할 때 사용하는 메시지 |
| DHCP Inform                         | 이미 IP 주소를 가진 클라이언트가 추가적인 구성 옵션 정보를 요청하는 메시지 |



## DHCP 서버 구성

DHCP 서버는 리눅스의 DHCP 데몬을 사용해 구성하거나, 스위치, 라우터. 방화벽, VPN과 같은 네트워크, 보안 장비에서도 DHCP 서비스가 가능하다.

DHCP 서버를 구성할 때 주로 설정하는 값은 다음과 같다.

- **IP 주소 풀(IP 범위)**: 클라이언트에게 할당할 수 있는 IP 주소의 범위. 이 주소 풀은 DHCP 서버가 관리하며, 클라이언트가 DHCP 서버에 IP 주소를 요청하면 서버는 이 범위 내에서 주소를 할당한다.
- **예외 IP 주소 풀(예외 IP 범위)**: IP 주소 풀 내에서도, 특정 IP 주소는 예외적으로 할당되지 않는다. 이 주소들은 대개 네트워크 장비나 서버 등, 고정 IP 주소가 필요한 장치에게 할당된다.
- **임대 시간(Lease Time)**: DHCP 서버가 IP 주소를 얼마 동안 클라이언트에게 "임대"해 줄 것인지를 정하는 시간. 임대 시간이 만료되면, 클라이언트는 IP 주소를 갱신하거나 새로운 IP 주소를 요청해야 한다.
- **서브넷 마스크(Subnet Mask)**: IP 주소와 함께 할당되는 정보로, 이를 통해 클라이언트는 자신이 속한 네트워크 (서브넷)를 파악할 수 있다.
- **게이트웨이(Router)**: 클라이언트가 인터넷 등 외부 네트워크로 접근할 때 사용하는 라우터의 IP 주소
- **DNS(Domain Name Server)**: 클라이언트가 도메인 이름을 IP 주소로 변환하는 데 사용하는 DNS 서버의 IP 주소