# 7.3~7.4장

# GSLB(Global Server/Service Load Balancing)

DNS에서 동일한 레코드 이름으로 서로 다른 IP 주소를 동시에 설정할 수 있다. 이를 DNS 로드밸런싱이라고 한다.

DNS는 서비스 상태를 확인하지 않기 때문에 특정 서버에 문제가 있을때 문제가 생긴다. GSLB는 DNS의 문제점을 해결해 도메인을 이용한 로드밸런싱 구현을 도와준다.

GSLB는 DNS와 동일하게 도메인 질의에 응답하고 동시에 헬스체크를 하며 로드밸런싱(라운드 로빈)을 한다.

### GSLB 동작 방식

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/344539d2-edf2-4a73-861d-0cb4ebd43b84)

1. 사용자가 요청을 하면 Local DNS부터 확인하고,
2. DNS 서버로부터  GSLB 정보를 얻는다.
3. GSLB로부터 정보를 얻는다.

GSLB는 단순히 도메인 주소를 응답하는 것이 아니라 FQDN(풀 도메인)에 대해 헬스체크를 한다.

### GSLB 구성 방식

- **도메인 자체를 GSLB로 사용**
    
    해당 도메인에 해당하는 모든 레코드 설정을 GSLB에서 관리하는 방식이다.
    
    GSLB가 DNS 역할을 하기 때문에 헬스체크 기능이 불필요하고, GSLB가 모든 부하를 받게 된다.
    
- **도메인 내의 특정 레코드만 GSLB로 사용**
    
    GSLB 적용이 불필요한 경우가 많아 특정 레코드에 대해서만 GSLB에게 이관하는 방식이다.
    
    - 별칭 사용(CNAME)
        
        실제 도메인과 다른 도메인 레코드로 GSLB에 등록한다. 
        
        일반적으로 외부 CDN을 사용하거나 회사 내부 GSLB를 사용하는 도메인이 많은 경우 한번에 관리하기 위해 사용한다.
        
        DNS 서버로부터 새로운 도메인을 받아, NS에 다시 요청해 GSLB에 요청한다.
        
    - 위임 사용(NS)
        
        실제 도메인과 동일한 도메인 레코드를 사용하며 도메인 전체를 위임하는 것이다.
        
        도메인을 그대로 사용하고, IP 값을 통해 GSLB에  요청한다.
        

### GSLB 분산 방식

- 서비스 제공 여부를 체크해 트래픽 분산
- 지리적으로 멀리 떨어진 다른 데이터센터에 분산
- 지역적으로 가까운 서비스에 접속해 더 빠른 서비스 제공하도록 분산

헬스 체크를 통해 서비스를 안정적으로 제공하는 것 외에 다른 사이트로 서비스를 분산하는 것이 GSLB의 중요한 역할이다.

로드밸런싱 방식에는 라운드 로빈, 최소 접속, 해싱등 다양한 방법이 있다.

GSLB는 헬스 체크 모니터링 요소로 RTT/Latency와 IP 지역 정보를 제공한다.

분산을 처리할때 지역정보를 통해 가까운 사이트로 분산처리 한다.

# DHCP(Dynamic Host Configuration Protocol)

IP와 네트워크 정보를 동적할당 하고 테이블에 기록할때 사용되는 프로토콜을 뜻한다.

DHCP는 BOOTP 프로토콜을 기반으로 한다. 클라이언트 포트는 68, 서버 포트는 67이다.

### DHCP 동작 방식

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/65e6899b-a8d4-49ff-9823-d083922544de)

1. 클라이언트는 DHCP 서버를 찾기 위해 브로드캐스트를 날린다. (UDP로 전송)
2. DHCP 서버가 수신 후 클라이언트에게 할당할 IP, 서브넷, DNS정보등을 브로드캐스트로 전송한다.
3. 서버로부터 받은 정보를 포함해 DHCP 요청을 브로드캐스트로 전송한다.
4. 클라이언트로부터 받은 정보를 기록하고 정상적으로 수신했다는 응답을 보냅니다.

DHCP가 할당한 IP는 임대시간이 있어 임대시간이 만료되면 IP를 회수한다.

임대시간의 절반 이상이 지나고 클라이언트가 계속 사용중이라면, 위의 3,4 과정을 통해 갱신을 시도한다.

### DHCP 서버 구성

DHCP 서버에 설정하는 값은 다음과 같다.

- IP 주소 풀(범위)
- 예외 IP 주소 풀
- 임대 시간
- 서브넷 마스크
- 게이트웨이
- DNS

**리눅스에서 DHCP 서버 구성**

1. dhcp 패키지 설치
2. dhcpd.conf 파일 작성
3. 재시작

### DHCP 릴레이

DHCP에서 사용되는 패킷은 모두 브로드캐스트로 전송되기 때문에 네트워크마다 DHCP가 있어야 한다.

네트워크가 여러개인 환경에서 DHCP를 이용하려면 여러개 사항을 고려해야 한다. DHCP 릴레이 Agent를 사용하면 DHCP 서버 한 대로 여러 네트워크 대역에서 IP 풀을 관리할 수 있다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/a3d74f96-bf93-4dd0-a036-01f43a7605f3)

다음과 같이 구성을 하여 여러개의 네트워크에서 하나의 DHCP를 사용할 수 있다.

이때 어떻게 통신이 이루어지는지 알아보자.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/09e1835a-7784-4349-a930-129b1861afa1)

1. 클라이언트가 브로드캐스트 패킷 전송을 한다.
2. 릴레이 에이전트가 받아 출발/도착지 IP를 수정하여 DHCP 서버로 요청을 전달한다.
3. DHCP 서버는 릴레이 에이전트에게 Offer를 유니캐스트로 보낸다.
4. 3에서 받은 내용을 출발지 IP를 수정하여 릴레이 에이전트가 브로드캐스트로 전송한다.
5. 클라이언트는 4에서 받은 내용으로 브로드캐스트로 보낸다.
6. 5를 유니캐스트로 변환해 DHCP 서버로 전송
7. DHCP 서버는 받은 내용을 기록하고 응답을 유니캐스트로 전송한다.
8. 7에서 받은 내용을 브로드캐스트로 전환하여 전달한다.

DHCP와 DHCP 릴레이 Agent는 유니캐스트로 동작하기 때문에 같은 L2 네트워크에 존재해야 하모, DHCP 서버에는 유니캐스트로 전달하기 위해 DHCP IP 주소를 등록해놔야 한다.
