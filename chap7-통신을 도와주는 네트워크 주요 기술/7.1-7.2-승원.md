# 7.1~7.2장

# NAT/ PAT

NAT(Network Address Translation)
네트워크 주소 변환 기능으로서, 1 : 1 또는 주소 고갈 문제로 1 : N 으로 변환하기도 한다. 공유기, 통신사, 회사 네트워크, 라우터, 스위치등에서 사용하는 기능이다.

PAT(Port Address Translation)
NAT와 동일하다. 1 : N 변환을 NAPT 또는 PAT라고 부른다.

IP 주소를 변환할 때 공인 IP → 사설 IP, IPv4 → IPv6, 사설 IP → 공인 IP 가능.

### NAT/PAT의 용도와 필요성

- IPv4 주소 고갈 문제
    
    IPv4 주소가 고갈되어 세가지 해결법이 제시되었다. (서브네팅, NAT + 사설 IP, IPv6)
    
- 보안 강화
    
    외부와 통신할 때 내부IP를 숨기고 외부 IP로만 통신할 수 있다. 또한 NAT 과정에서 변환이 안되는 경우 통신이 안된다.
    
![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/07d052ff-5799-4a48-b991-e2543ce9d2f6)
    
- 주소 체계가 같은 네트워크 통신
    
    사설 IP는 외부 IP로 변환되어 사용되기 때문에 다른 사설망의 IP와 겹쳐도 된다. 
    
- 불필요한 설정 변경 감소
    
    IDC를 옮겨 새로운 공인 IP를 할당받는 경우, 외부와 NAT 설정은 변경해야 하지만, 내부 네트워크는 그대로 사용 가능하다.
    

NAT의 장점을 알아봤는데, 사실 장점만 있는 기술은 없다. NAT 환경으로 인해 애플리케이션을 개발할 때 더 많은 고려사항이 생겼고, 네트워크 엔지니어가 변경된 IP에서 장애가 일어나도 찾아내기 어려워 졌다.

### 동작 방식

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/2a063d12-f2ff-469d-80ad-50c0690fe6ca)

NAT : 테이블을 거쳐 출발지/목적지 IP를 변환해준다.

PAT : NAT와 동일 하지만, IP와 포트까지 변환해준다.

PAT는 서비스 포트 개수가 제한되어 있어 재사용하는데, 포트가 모두 사용되고 있는 경우 PAT가 정상적으로 작동하지 않아 IP 풀을 구성해야 한다.

PAT IP가 목적지일 때는 어느 IP에 바인딩 되는지 확인할 NAT 테이블이 없기 때문에 DNAT에 적용되지 않는다.

### SNAT, DNAT

기준은 NAT가 일어나기 전 시작 지점이다.

SNAT : 출발지 주소 변경 (사설 IP → 공인 IP, IP 숨길 때, 로드밸런서를 스킵할 때)

DNAT : 도착지 주소 변경 (로드밸런서에서 요청을 처리할 때, 대외망과 네트워크 구성할 때)

### 정적 NAT,  동적 NAT

정적 NAT : 매핑 관계를 사전 정의한다. 1:1 NAT, 테이블 타임아웃 없음.

동적 NAT : NAT 수행하며 매핑관계 저장. 1:N, N:M, 테이블 타임아웃 있음.

동적 NAT는 출발지와 목적지 모두 정의된 것이 아니라 다수의 IP에서 정해지므로 pool이나 range로 설정되어 있다.

* IP pool(range) : 특정 네트워크 내에서 IP 주소의 순차적 범위

# DNS(Domain Name System)

도메인 주소를 IP 주소로 변환하는 역할이다.

### DNS 소개

외우기 어려운 IP 주소 대신 문자열을 사용하는 방법이다.

도메인 주소를 이용하면 IP주소가 변경되어도 서비스를 유지할 수 있고, 여러개의 IP 주소를 사용할 수 있다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/87086cdb-3e52-4b60-af6d-bdf51eb9bcdc)

동작 과정을 간단히 살펴보면 사용자가 도메인 주소를 입력하면 DNS서버로부터 IP 주소를 받아 요청을 보낸다.

### DNS 구조와 명명 규칙

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/d6495d08-740a-4c7e-9815-1a26dc6e9e8d)

보통 3계층으로 이루어져 있으며, 128 계층까지 가능하고, 한 계층에 최대 63바이트, 전체 길이 255바이트이다. 도메인에는 알파벳, 숫자, -만 넣을 수 있다.

- 루트 도메인
    
    도메인을 구성하는 최상위 영역. 
    
    DNS 서버는 사용자가 쿼리한 도메인에 대한 값을 갖고 있거나 캐시를 이용해 응답한다.
    
    DNS 서버에 해당하는 정보가 없으면, 루트 DNS로 쿼리한다.
    
- Top Level Domain
    - Generic(gTLD)
    일반적으로 사용되는 최상위 도메인 (.com, .edu, .gov 등) 제한 없음
    - Country Code(ccTLD)
    국가 최상위 코드(.co.kr 등)
    - Infrastructure
    인프라 식별자 공간을 지원하기 위해 사용되는 도메인 (.arpa)
    - Generic restricted(grTLD)
    특정 기준을 충족하는 사람이나 단체 (.biz, .name 등)
    - Test(tTLD)
    테스트 목적으로 사용되는 도메인(.test)

### DNS 동작 방식

**클라이언트**

DNS에 쿼리를 날려 IP 주소로 변환하는데, DNS 서버 없이 로컬에서 변환할 수 있다. 로컬의 hosts 파일에 도메인과 IP 정보를 저장하면 DNS 캐시에 정적 캐시로 저장된다.

성능상 이점 때문에 DNS 서버에 쿼리하기 전에 캐시를 먼저 확인하게 되는데, hosts 파일 외에도 질의 했던 내용들은 동적 캐시로 저장되어 사용된다.

**DNS 서버**

DNS 서버에서 모든 도메인의 정보를 가지고 있지 않다. 따라서 DNS 서버마다 정보가 분산 저장되어 있다.

1. 로컬 캐시에 도메인 정보가 없다면 DNS에 쿼리를 보낸다.
2. DNS 서버에도 해당하는 도메인 정보가 없다면 루트 DNS에 쿼리를 보낸다.
3. 루트 DNS는 도메인의 TLD값을 확인하여 해당하는 TLD를 관리하는 DNS 정보를 응답한다.
4. 응답받은 DNS 서버에 도메인 정보 쿼리를 보낸다.
5. 응답받은 정보를 클라이언트로 반환하고, 캐시에 저장한다.

그림으로 나타내면 다음과 같다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/ccab7de9-7974-41a6-a61c-ca64b7f21ee0)

### Master - Slave

DNS는 다른 Master-Slave 처럼 이중화 목적 또는, 읽기 쓰기 목적으로 나눠지지 않았다.

두 서버 모두 쿼리에 응답하고, Master 서버가 다운되고 만료시간까지 복구하지 못하면 Slave 서버도 다운된다.

Slave는 Master로부터 zone파일을 복제하여 동기화 하는데, Master에서 복제 가능한 서버를 지정할 수 있다.

### DNS 주요 레코드

- A(IPv4)
사용자가 DNS에 질의한 주소를 A레코드에 설정된 IP주소로 응답한다. 1:1, 1:N 매팽이 가능하다.
- AAAA(IPv6)
A와 같고, IPv6라는점만 다르다.
- CNAME(별칭)
별칭 레코드로 도메인 주소를 매핑한다.(www 등)
- SOA(Start Of Authority)
도메인 영역에 대한 권한을 나타낸다. 만료시간 등을 나타낸다.
- NS(Name Server)
도메인에 대한 권한이 있는 네임 서버 정보를 설정하는 레코드. 다른 서버로 위임하는 역할로도 많이 사용한다.
- MX(Mail eXchange)
메일 서버를 구성할 때 사용되는 레코드. 우선순위가 있다.
- PTR(Pointer)
A 레코드와 반대로 IP 주소에 대한 질의를 도메인으로 응답하기 위한 레코드.
- TXT(Text)
도메인 설명같이 간단한 텍스트를 입력할 수 있는 레코드.

### DNS에서 알아두면 좋은 내용

- 도메인 위임 : 
도메인 서버가 모든 레코드를 직접 관리하지 않고, 일부 영역은 다른 곳에서 레코드를 관리하도록 위임하는 방법. 위임 기능을 사용해 특정 영역을 다른 네임 서버에서 관리할 수 있도록 한다.(GSLB등 다양한 용도로 사용된다.)
    
    *  GSLB : 특정 지역에 집중되는 트래픽을 분산하는 DNS 기반 로드밸런싱
    
- TTL(Time To Live) : 
로컬 캐시에 결과값을 유지하는 시간을 뜻한다. (윈도우 1시간, 리눅스 3시간), refresh, retry, expire등 설정도 있다.

- 화이트 도메인 :
정상적으로 발송하는 대량 이메일이 RBL 이력으로 간주되어 차단되는 것을 예방하기 위해 사전에 등록된 개인이나 사업자에 한해 국내 주요 포탈 사이트로의 이메일 전송을 보장해주는 제도. KISA RBL 사이트에서 등록해야 한다.
    
    * RBL : 실시간 블랙리스트
    
- 한글 도메인 :
한글 도메인을 사용하려면 한글을 퓨니코드로 변경하고 퓨니코드로 DNS 생성해야 한다.
    
    * 퓨니코드 : 영어가 아닌 자국어 도메인을 사용할 수 있도록 해주는 표준 코드(아스키로 변환됨)
    

### DNS 설정(Linux)

bind 패키지를 사용하는 과정이다.

1. 패키지 다운로드
2. DNS를 위해 53포트를 열어준다.
3. 도메인 타입(master or slave)을 지정하고, zone 생성 및 레코드 정의
4. 서비스 데몬 실행
