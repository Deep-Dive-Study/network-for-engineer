# 12장 로드 밸런서

# 부하 분산이란

서비스 규모가 커지거나 고가용성을 위해 서버를 여러대 사용하는 경우 요청을 적절히 분산하기 위해 L4, L7 로드밸런서를 사용한다.

방화벽을 통과하며 세션 테이블에 기록하지만, 출발지와 목적지 경로가 다른 경우 패킷이 폐기되기도 한다. 이떄 FWLB가 사용되어 출발지와 목적지가 같은 경로를 사용하도록 한다.

* FWLB - 방화벽 부하 분산

* SLB - 서버 부하 분산

# 부하 분산 방법

로드 밸런서의 가상 IP에 실제 서버들의 IP를 로드밸런서에 바인딩 하고

사용자는 로드 밸런서의 가상 IP에 요청을 하면 바인딩된 서버들의 IP로 요청을 전달한다.

로드 밸런서 그룹을 만들땐 3계층 정보인 IP 뿐만 아니라 4계층 정보인 포트까지 함꼐 지정한다 그래서 L4 스위치라고도 한다. (7 계층 정보까지 확인 후 처리하는 것은 L7 스위치)

로드 밸런스 그루핑을 할 때 프로토콜 별로 다른 포트를 지정해 VIP를 여러개 만들 수 있다.

# 헬스 체크

로드 밸런서는 주기적으로 연결된 각 서버의 헬스 체크를 통해 부하를 분산 해도 되는지 체크한다

### 방식

- ICMP
    
    ICMP로 핑 체크 하는 방법으로 서버가 살아있는지 유무만 체크한다. (잘 사용하지 않는다)
    
- TCP 서비스 포트
    
    연결된 포트로 SYN을 보내 ACK를 받는 방법이다. 실제 서비스 포트 외에도 다른 포트도 가능
    
- TCP 서비스 포트 : Half Open
    
    TCP 헬스 체크는 부하가 생겨 3/4 hand shake가 아닌 3번의 통신만으로 세션을 끊는다.
    
- HTTP 상태 코드
    
    TCP 통신은 되지만 HTTP 통신은 안되는 경우가 있다. 3way hand shake 이후 HTTP 200확인한다.
    
- 콘텐츠 확인
    
    콘텐츠가 정상적으로 응답하는지 확인하는 방식이다. 서버 인스턴스 뿐만 아니라 WAS가 살아있는지 체크한다.
    

### 주기와 타이머

주기, 응답 시간, 시도 횟수, 타임 아웃등 다양한 설정이 가능하다.

- 주기 - 어느 시점 마다 한 번씩 보내는지
- 응답 시간 - 응답을 기다리는 최대 시간
- 시도 횟수 - 정상적인 응답을 받지 못하면 시도 횟수 만큼 헬스 체크를 다시 시도한다.

# 부하 분산 알고리즘

- 라운드 로빈(RR)
    
    특별한 규칙 없이 구성된 장비를 순차적으로 돌아가면서 분산한다.
    
- 최소 접속 방식
    
    연결된 세션이 가장 적은 서버에 분산한다.
    
- 해시
    
    서버의 부하 분산보다 같은 사용자는 같은 서버에 접속하도록 하는 방식
    
    서버 상태를 고려 않고, 해시 알고리즘을 통해 분산 한다.
    
    해시와 다른 알고리즘을 섞어 유지하는 옵션(Sticky)도 있다.
    

# 로드 밸런서 구성 방식

구성과 위치에 따라 2가지로 나뉜다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ca2cad50-7418-4538-97d6-f0eaa1d89ae8/Untitled.png)

### 원암 구성

로드 밸런서가 중간 스위치 옆에 연결되는 구성. 부하 분산을 수행하는 트래픽에서만 로드 밸런서를 경유한다.

사진에선 L2 스위치가 하나의 인터페이스로 연결되어 있지만, LACP/다른 네트워크와 같은 다수의 인터페이스로 연결되어도 원암이라고 불린다.

원암 구성의 재밌는 점은 부하 분산을 수행하는 트래픽만 로드 밸런서를 경유하는 점인데, 부하 분산에 사용되는 IP 정보를 로드 밸런서가 갖고 있어 경유 한다.

원암 구조에서 응답이 다시 로드 밸런서를 거칠 때 서비스 IP와 실제 서버, 그리고 응답을 받을 사용자, 로드밸런서 IP에 대해 NAT가 이루어져야 한다. (Source NAT 방식도 있음)

로드 밸런서를 통과하지 않아도 되는 트래픽이 많은 경우 자주 사용되며 대역폭 확장이 비교적 간편하다

### 인라인 구성

서버로 가는 경로상에 로드 밸런서가 연결되는 구성. 모든 트래픽이 로드 밸런서를 경유한다.

구조가 직권적이고 이해하기 쉽지만, 로드 밸런서에 부하가 많아진다.

L4 장비는 L3 장비보다 많은 정보를 처리하므로 가격이 비싸서 성능을 고려하지 않을 수 없다.

로드 밸런싱을 하지 않는 패킷이 통과할 땐 부하를 거의 받지 않기 때문에 성능, 쓰루풋을 구별해야 한다.

물리적으로 원암 구성을 하고 논리적으론 인라인으로 처리하는 경우도 있다.
