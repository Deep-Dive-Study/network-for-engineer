라우터는 3계층에서 동작하는 여러 네트워크 장비의 대표격으로 경로를 지정해주는 장비이다.

라우터에 들어오는 패킷의 **목적지 IP 주소**를 확인하고 자신이 가진 경로 정보를 이용해 **최적의 경로**로 포워딩 한다. 라우터는 원격지 네트워크와 연결할 때 필수이자 핵심 장비이다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/16d6dc8d-8c50-4b95-9ec9-fdf89615dfc1)

* 예전엔 라우터와 L3 스위치를 구분했지만 최근에는 거의 동일하다 보면 된다.

# 5.1 라우터의 동작 방식과 역할

라우터는 다양한 경로 정보를 수집해 **최적의 경로를 라우팅 테이블에 저장**한 후 패킷이 들어오면 **최선의 경로로 패킷을 내보낸다**.

반대로 들어온 패킷의 목적지가 라우팅 테이블에 없으면 패킷을 버린다. 라우터는 패킷 포워딩 과정에서 기존 2계층 헤더 정보를 제거한 후 새로운 2계층 헤더를 만든다. 하나씩 자세히 알아보자

### 경로 지정

라우터의 가장 중요한 역할로 라우팅 테이블에 저장하고, 경로를 지정한다.

라우터는 경로 정보를 얻는 역할과 포워딩 하는 역할로 구분되는데, 자신이 얻은 경로로 포워딩 하기 때문에 **정확한 목적지 경로를 얻는 것**이 중요하다.

경로 정보 얻는 방법

1. IP 주소를 입력하면서 인접 네트워크 정보를 얻는 방법
2. 관리자가 직접 경로를 입력하는법
3. 라우터끼리 경로 정보를 교환하는 방법

### 브로드캐스트 컨트롤

스위치의 브로드캐스트 플러딩은 LAN의 크기가 작고, NIC에서 자신의 주소가 아닌 패킷은 버리기 때문에 큰 무리를 주지 않는다. 반면에 라우터에서 명확하지 않은 패킷이 플러딩 된다면 인터넷이 패킷으로 가득차 통신 불능 상태가 될 수 있다.

라우터는 바로 연결되어 있는 네트워크를 제외하고 경로가 없으면 패킷을 포워딩할 수 없다. 라우터는 멀티캐스트 정보를 습득하지 않고, 브로드캐스트 패킷을 전달하지 않는다. 이 기능을 통해 브로드캐스트가 다른 네트워크로 전파되는 것을 방지할 수 있다. 이를 브로드(멀티)캐스트 컨트롤이라고 한다.

네트워크에 브로드캐스트가 많이 발생하는 경우 라우터로 네트워크를 분리하면 브로드캐스트 네트워크를 분할해 네트워크 성능을 높일 수 있다.

### 프로토콜 변환

라우터의 또 다른 역할은 서로 다른 프로토콜로 구성된 네트워크를 연결하는 것이다. 현대는 이더넷으로 수렴되지만, 과거에는 LAN과 WAN의 프로토콜은 완전히 구분된 공간이었다. 

라우터는 3계층 장비이므로 2계층까지의 헤더 정보를 벗겨내고 2계층 헤더 정보를 새로 만들어 외부로 내보낸다. 

# 경로 지정 - 라우팅/스위칭

라우터가 패킷을 처리할 때 크게 두 가지 작업을 수행한다.

- 경로를 얻어 경로 정보를 정리하는 역할
- 정리된 경로 정보를 기반으로 패킷을 포워딩하는 역할

경로 정보가 점점 더 다양하고 많아졌기 떄문에 라우터는 서브넷 단위로 라우팅 정보를 습득한다. 그리고 이를 최적화 하기 위해 서머리 작업을 통해 여러개의 서브넷 정보를 뭉쳐 전달한다. 그래서 라우터에 들어온 패킷의 목적지 주소와 라우팅 테이블의 정보가 정확히 일치하지 않더라도 가장 근접한 정보를 찾아 패킷을 포워딩한다.

### 라우팅 동작과 라우팅 테이블

라우터는 목적지까지의 모든 경로를 책임지지 않고, 인접한 라우터(넥스트 홉) 까지만 경로를 지정하는데 이를 홉-바이-홉 이라고 한다.

넥스트 홉을 지정할 때 일반적으로 세 가지 방법을 사용한다.

- 다음 라우터의 IP를 지정한다.
- 라우터의 나가는 인터페이스를 지정한다.
- 라우터의 나가는 인터페이스와 다음 라우터의 IP를 모두 지정한다.

일반적으로 상대방 라우터의 인터페이스 IP주소를 지정하는 방법을 사용한다.

상대방 넥스트 홉 라우터의 IP를 모르고 MAC 주소를 알 수 있을때는 나가는 인터페이스를 지정하는 방법을 쓴다. 

인터페이스와 IP를 모두 지정하는 경우VLAN 인터페이스와 같은 논리적인 인터페이스를 사용할 수 있다.

라우터가 패킷을 포워딩 할때는 출발지를 고려하지 않고 목적지 주소만 보고 포워딩 한다. 따라서 라우팅 테이블에는 다음과 같은 정보만 수집한다.

- 목적지 주소
- 넥스트 홉 IP 주소, 나가는 로컬 인터페이스(선택 가능)

물론 출발지 주소를 이용해 라우팅이 가능하지만, 다른 라우터로의 전파가 어려우며 별도의 설정이 필요하고, 관리가 어려워 특별한 상황에서만 사용한다.

* 3계층 장비는 2계층과 다르게 TTL이 있어 루프 현상이 일어나도 일정 시간이 지나면 자동으로 사라진다.

### 라우팅

라우터가 경로 정보를 얻는 방법은 크게 3가지가 있다.

**다이렉트 커넥티드**

IP 주소를 입력할 때 사용된 IP 주소와 서브넷 마스크로 해당 IP 주소가 속한 네트워크 주소를 알 수 있다. 이 정보를 통해 라우팅 테이블을 자동으로 만드는데, 강제로 지울 수 없으며 해당 네트워크가 삭제되거나 비활성화 되어야 사라진다.

**스태틱 라우팅**

관리자가 목적지 네트워크와 넥스트 홉을 라우터에 직접 지정하는 방법. 매우 직관적이다.

해당 네트워크가 삭제되거나 비활성화 되면 사라지고, 물리 인터페이스가 비활성화 되더라도 논리 인터페이스가 비활성화되지 않으면 삭제되지 않는다.

**다이나믹 라우팅**

규모가 큰 네트워크에서는 스태틱 라우팅으로는 버겁다. 장애 사항을 파악하고 대체 경로를 찾아야 하기 때문인데, 대응을 적절히 하지 못하면 패킷은 드롭된다.

다이나믹 라우팅은 라우터끼리 알고 있는 경로 정보나 링크 상태 정보를 교환해 전체 네트워크 정보를 학습한다. 따라서 회선이나 라우터에 장애가 발생해도 이를 인지하고 대체 경로로 포워딩한다.

다이나믹 라우팅에서는 정보 공유를 위해 자신이 광고할 네트워킹을 선언해야 한다.

다이나믹 라우팅의 역할은 경로정보를 얻는 것, 경로 정보를 체계적으로 데이터베이스화 하고 순위를 부여해 최선의 경로만 수집하는 것이 있다.

라우터가 수집한 경로 정보를 원시 데이터라고 하고 토폴로지 테이블에 담고, 최적의 경로를 라우팅 테이블에 담는다.

### 스위칭

스위칭은 라우팅 테이블을 참조해 최적의 경로를 찾아 외부로 포워딩하는 작업을 뜻한다.

이때 정확히 일치하지 않고 비슷하게 일치하거나 일치하지 않는 상황 때문에 고려해야 하는 사항이 있는데, Longest Prefix Match 기법을 사용해 라우팅 테이블에 있는 가장 가까운 경로를 선택한다.

LPM 기법은 라우터에서 부하가 걸리기 때문에 한 번 스위칭 작업을 수행한 정보는 캐싱해 사용한다. 보통 동일한 출발지와 도착지 포트번호로 여러 패킷을 보내기 떄문에 캐시 히트율이 좋다.

단순히 목적지 IP부터 출발지와 도착지 IP, 포트 번호를 모두 저장하기도 한다. 나아가 넥스트 홉 L2 정보까지 캐싱해 스위칭 시간을 줄이기도 한다.

* Longest Prefix Match(Maximum PRefix Length Match)

목적지와 더 많이 매칭되는 정보를 최선의 정보로 인식하는 기법

### 라우팅, 스위칭 우선 순위

우선순위는 경로 정보를 받은 방법과 거리를 기준으로 결정한다.

라우팅 기법에 따른 우선순위는 기본적으로 다이렉트 커넥티브, 스태틱, 다이나믹 순이다. 하지만 관리자가 우선순위를 조정할 수 있다. 이를 AD(Administrative Distance)라고 한다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/4935a0af-2e14-482c-961f-65e83049a8a7)

가중치 값이 동일한 경우에는 코스트 값으로 우선순위를 정한다. 코스트 값까지 동일한 경우에는 ECMP 기능으로 동일한 코스트 경로를 모두 활용해 트래픽을 분산한다.

패킷을 스위칭할 떄는 LPM 기법으로 우선순위를 정한다.

* 코스트 값은 거리를 나타내는 값으로 라우팅 프로토콜 마다 기준이 다르다

정리하면 다음과 같다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/fdb25079-14ca-4819-b123-27f0610b4213)
