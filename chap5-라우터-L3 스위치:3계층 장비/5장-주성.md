# 5장. 라우터 / L3 스위치 : 3계층 장비

**`라우터`**
- **3계층에서 동작하는 여러 네트워크 장비의 경로를 지정해주는 장비**

- **패킷의 목적지 IP 주소를 확인하고 자신이 가진 경로(Route) 정보를 이용해 패킷을 최적의 경로로 포워딩함**

- 원격지 네트워크와 연결할 때 반드시 필요한 장비

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/cda5f35e-6210-42bf-ae8f-a879e51d4650)

#### 라우터와 L3 스위치?
- 기존에는 라우터는 소프트웨어로 스위치는 하드웨어로 구분했었음

- 혹은 다양한 기능의 라우터와 패킷을 빠르게 보내는데 최적화된 스위치로 구분하기도 했음

- 최근에는 이러한 구분이 모호해져 구분하기 어려움
  
## 5.1 라우터의 동작 방식과 역할
- **`다양한 경로 정보를 수집`** 해 **`최적의 경로를 라우팅 테이블에 저장`** 한 후 패킷이 라우터로 들어오면 **`도착지 IP 주소와 라우팅 테이블을 비교해 최선의 경로로 패킷을 내보냄`** 

- 스위치와 달리 들어온 패킷의 목적지 주소가 라우팅 테이블에 없으면 **`패킷을 버림`**

- 패킷 포워딩 과정에서 기존 2계층 헤더 정보를 제거한 후 **`새로운 2계층 헤더 제작`**

- **`경로 지정`**, **`브로드캐스트 컨트롤`**, **`프로토콜 변환`**

### 5.1.1 경로 지정
- **`경로 정보를 모아 라우팅 테이블 제작`**
  
- 패킷이 라우터로 들어오면 패킷의 **`도착지 IP 주소 확인`** → `경로 지정` 및 `패킷 포워딩` 수행
  - 네트워크 주소 기반으로 경로 설정
  
- **`경로 정보를 얻는 역할`**
  - IP 주소를 입력하면서 자연스럽게 인접 네트워크 정보를 얻는 방법
    
  - 관리자가 직접 경로 정보를 입력하는 방법
    
  - 라우터끼리 서로 경로 정보를 자동으로 교환하는 방법
      
- **`패킷을 포워딩하는 역할`**
  - 얻은 경로 정보를 확인하고 정보가 있는 패킷만 포워딩함

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/55e68558-4f66-4e91-bb03-1158ddad4ef0)

### 5.1.2 브로드캐스트 컨트롤(Broadcast Control)
- **`분명한 도착지 정보가 있을 때만 통신을 허가함`**
  
- 바로 연결되어 있는 네트워크 정보를 제외하고 경로 습득 미설정 시 패킷 포워딩 불가능

- 멀티캐스트 정보를 습득하지 않고 브로드캐스트가 다른 네트워크로 전파되는 것 방지

- 쓸모없는 통신이 네트워크를 차지하는 것을 최대한 막으려고 함
  - 브로드캐스트가 자주 발생하는 경우라면 네트워크를 분할하여 성능을 향상시킬 수 있음 

### 5.1.3 프로토콜 변환
- **`서로 다른 프로토콜로 구성된 네트워크 연결`**

- 과거에는 LAN과 WAN 간의 프로토콜이 달라 이를 연결해줄 필요가 있었음(현재에도 일부 존재)
  - WAN 구간은 PPP 프로토콜 사용
    
  - LAN 구간은 이더넷 프로토콜 사용

- **`2계층 헤더 정보를 새로 만들어 외부로 내보냄`**
  - 해당 기술을 활용하여 다른 기술간 변환을 가능하게 함

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/0f1e07a7-1aec-4705-8d78-988aa3215980)

## 5.2 경로 지정 - 라우팅 / 스위치
- 라우터가 패킷을 처리할 때 두가지 작업을 수행함
  - **`경로 정보를 얻어 경로 정보 정리하는 역할`**
    
  - **`정리된 경로 정보를 기반으로 패킷을 포워딩하는 역할`**
  
- 라우터가 정상적으로 동작하기 위해서는 패킷이 들어오기 전에 경로 정보를 충분히 수집하고 있어야 함
  - 경로 정보(라우팅 테이블)를 적절하게 유지해야 함

- 목적지와 정확히 일치하지 않는 경우가 더 많음 
  - 따라서, 목적지에 가장 근접한 정보를 찾아 패킷 포워딩하는 방식을 활용함

  - **서브넷 단위로 라우팅 정보 습득** , **라우팅 정보 최적화** 하기 위해 여러 개의 서브넷 정보를 뭉쳐 전달함(**`서머리 작업`**)

### 5.2.1 라우팅 동작과 라우팅 테이블
- 단말부터 목적지까지 경로를 모두 책임지는 것이 아니라 인접한 라우터까지만 경로를 지정하면 인접 라우터에서 최적의 경로를 다시 파악한 후 라우터로 패킷을 포워딩함
  - 이러한 방식을 **네트워크를 한 단계씩 뛰어넘는다**는 의미로 **`홉-바이-홉(Hop-by-Hop)`** 이라함

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/825b5142-4c58-4b2b-b8a4-1588d029e89b)
  
- 최적의 넥스트 홉 선택 후 보냄

  - **`넥스트 홉(Next Hop)`** : 인접한 라우터
    - 다음 라우터의 IP 지정(넥스트 홉 IP 주소)
      
    - 라우터의 나가는 인터페이스 지정
      
    - 라우터의 나가는 인터페이스와 다음 라우터의 IP 동시 지정
  
- 일반적으로 라우터에서 넥스트 홉 지정할 때는 상대방 라우터의 **인터페이스 IP 주소**를 지정
  - 인터페이스 지정시 일반적으로 물리 인터페이스를 지정하지만 IP와 인터페이스를 동시에 사용할 때는 VLAN과 같은 논리 인터페이스를 사용하기도 함
  
- 특수한 경우에는 라우터의 나가는 인터페이스를 지정
  - 상대방 넥스트 홉 라우터의 IP를 모르더라도 MAC 주소 정보를 알아낼 수 있을 때만 사용

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/213efea1-6b30-4eda-92c9-b4fdc305c8c3)

- 목적지 주소와 라우팅 테이블을 비교해 어느 경로로 포워딩할지 결정
  - **`라우팅 테이블`** : 목적지 정보만 수집
    - 목적지 주소
      
    - 넥스트 홉 IP 주소, 나가는 로컬 인터페이스(선택 가능)
      
    - PBR(Policy-Based Routing), 소스 라우팅(Source Routing), 폴리시 라우팅(Policy Routing) → 특수 기능

#### 소스 라우팅과 PBR, 정책 라우팅
`PBR`
- 라우터에서 패킷의 출발지 주소를 이용하도록 설정

- 출발지 IP뿐 아니라 도착지 IP와 포트 번호, 등의 다양한 조건을 합쳐 사용할 수 있음

`소스 라우팅`
- 라우터가 경로를 지정하는 것이 아니라 출발지에서 경로를 지정하는 것

- 일부에서는 소스 라우팅과 PBR을 동일하게 사용하지만 정확히는 다른 의미임으로 문맥에 사용해야함 

#### 루프가 없는(Loop Free) 3계층 : TTL(Time To Live)
- **패킷이 네트워크에 살아 있을 수 있는 시간(홉)을 제한**
  
- **`라우팅 루프`** : 순간적으로 마주보는 두 대의 라우터의 넥스트 홉이 각각 상대방으로 구성되어 패킷이 두 라우터 사이에서 계속 오가는 경우 발생

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/96421461-0e3e-4e7e-8aa0-6ce16a28bf12)

- **`TTL`** : 수명 값, 하나의 홉을 지날 때마다 TTL 값 1 감소

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/c288fe84-d957-470c-a54d-acf381080ec8)

### 5.2.2 라우팅(라우터가 경로 정보를 얻는 방법)
- 라우터가 경로 정보를 얻는 방법은 크게 3가지로 구분할 수 있음

  - **`다이렉트 커넥티드`**
  
  - **`스태틱 라우팅`**
  
  - **`다이나믹 라우팅`**

- 위와 같은 방법을 통해 경로 정보를 수집하고 이를 바탕으로 목적지에 대한 최적의 경로를 선정해 테이블을 제작함

#### 5.2.2.1 다이렉트 커넥티드(Direct Connected)
- **해당 네트워크** 에 대한 라우팅 테이블을 자동으로 제작
  - IP 주소와 서브넷 마스크를 활요한 정보를 바탕으로

- 정보 강제 삭제 금지
  
- 해당 네트워크 설정 삭제, 해당 네트워크 인터페이스 비활성화 → 자동으로 삭제

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/59ec51b1-1700-4d5f-85d4-53e9679d4640)

#### 5.2.2.2 스태틱 라우팅(Static Routing)
- 관리자가 목적지 네트워크와 넥스트 홉을 라우터에 **직접 지정해 경로 정보를 입력하는 것**
  
- 라우팅 정보를 매우 직관적으로 설정, 관리 가능
  
- 연결된 인터페이스 정보가 삭제되거나 비활성화 → 연관된 스태틱 라우팅 정보 자동 삭제
  - 물리 인터페이스가 삭제되었지만 논리 인터페이스가 살아 있는 경우도 있어 이때는 삭제되지 않음

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/7d8450d5-b08c-4acd-98a6-c079fd4cb07e)

- 양방향으로 설정해주어야 함

- 큰 네트워크인 경우 관리하기 어렵고 다른 라우터의 상태 정보를 확인할 수 없음

#### 5.2.2.3 다이나밍 라우팅(Dynamic Routing)
- 라우터끼리 자신이 알고 있는 경로 정보나 **링크 상태 정보를 교환**해 전체 네트워크 정보 학습
  - 관리자의 개입 없이 라우터끼리 정보교환 → **`장애 인지 및 트래픽 우회`** 가 가능함

  ![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/0f9f0089-5b3c-42d5-90cb-f0112e6c30b9)

- 자신이 광고할 네트워크를 선언해주어야 함

**`라우터는 정보를 수집하는 것 뿐만아니라 정보를 저장함`**
- 정보를 저장할 때 최적의 경로만 추려서 별도 테이블에 미리 보관함
  - 토폴로지 테이블 : 라우터가 수집한 경로 정보, 원시 데이터(Raw Data)
    
  - 라우팅 테이블 : 경로 정보 중 최적의 경로를 저장하는 테이블

### 5.2.3 스위칭(라우터가 경로를 지정하는 방법)
- 패킷이 들어와 라우팅 테이블을 참조하고 최적의 경로를 찾아 라우터 외부로 포워딩하는 작업
  - 라우터가 패킷 경로를 지정해 보내는 작업

- 완벽히 일치하지 않더라도 일부만 일치한 경우에도 패킷을 보냄

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/5a1846be-c6d1-4529-96f7-3aa903b383c7)

- **`롱기스트 프리픽스 매치(Longest Prefix Match)`** : 갖고 있는 경로 정보 중 가장 가까운 경로 선택
  - 자신이 갖고 있는 라우팅 테이블에서 가장 좋은 항목을 찾는 알고리즘
    
  - LPM 테이블 : 라우터나 스위치에서 관리할 수 있는 라우팅 테이블 → 대략적인 성능 확인

  - 해당 작업은 라우터 많은 부하를 줌

- 부하를 줄이기 위해 캐시에 저장해서 사용함
  - 여러 개의 패킷이 연속적으로 보내지는 경우가 많기 때문
 
  - 단순히 목적지 IP만 캐시하는 경우
    
  - 출발지와 목적지 IP 모두 캐시하는 경우
  
  - 포트 번호 정보까지 포함해 플로를 모두 저장하는 경우
  
  - 넥스트 홉 L2 정보까지 캐시해 스위칭 시간을 줄이는 기법

### 5.2.4 라우팅, 스위칭 우선순위
- 토폴리지 테이블에서 **`경로 정보를 받은 방법`** 과 `거리를 기준`으로 좋은 경로를 추출하여 라우팅 테이블을 제작함

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/e27a5f24-8cd4-487b-bebb-1a948ed0ead3)

- 정보를 얻은 소스에 따라 가중치 달라짐
  - 라우터에 바로 연결된 네트워크(다이렉트 커넥티드)
    
  - 관리자가 경로를 직접 지정한 네트워크(스태틱 라우팅)
    
  - 라우팅 프로토콜로부터 경로를 전달받은 네트워크(다이나믹 라우팅)
    - 어떤 프로토콜을 사용했느냐에 따라서도 달라짐

- AD(Administrative Distance) : 필요에 따라 관리자가 조정한 우선순위

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/51f5279f-a613-469f-b43f-3e00110451fa)

- 가중치가 동일한 경우 코스트(Cost) 값으로 우선순위를 결정
  - 코스트마저 같다면 ECMP(Equal-Cost Multi-Path) 기능 활용 → 트래픽 분산

  - 코스트(Cost)는 일종의 거리를 의미하나 프로토콜마다 다름
    - RIP: 홉수
    - OSPF: 대역폭
    - EIGRP: 다양한 값 연산    

- 패킷을 스위칭할 때는 롱기스트 프리픽스 매치 기법 활용하여 우선순위 결정
  - 목적지와 가장 유사한 라우팅 경로를 선택하는 알고리즘

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/99165624/5fa590b9-69af-465c-8dd6-6627dbe5bf07)
