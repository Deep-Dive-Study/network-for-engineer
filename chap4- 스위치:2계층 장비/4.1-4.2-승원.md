# 4.1~4.2장

# 스위치 장비 동작

스위치는 여러 장비가 동시에 패킷 통신할때 간섭이 없도록 도와주는 장비이다.

기존에는 스위치가 없어 패킷 경합이 일어났었는데, 스위치 덕분에 네트워크 효율성이 향상되었다.

스위치의 핵심 역할은 패킷을 정확히 전송하는 것이다. 이는 2계층 주소를 이해하고 MAC주소와 단말이 위치하는 인터페이스 정보를 매핑한 MAC 주소 테이블을 갖고있어 해당 포트에만 전송 가능하다. 만일 테이블에 없는 주소를 가진 패킷이 들어오면 전체 포트로 패킷을 전송한다.

## 스위치 동작 방식

### 1. 플러딩

스위치가 부팅하면 네트워크 관련 정보가 아무것도 없다. 이떄 스위치는 요청이 들어온 포트를 제외하고 모든 포트로 패킷을 전달한다. (허브와 같음)
패킷 정보의 MAC 주소를 보고 이를 학습해 테이블을 만들고 이를 통해 패킷을 전송한다.

**비정상적인 플러딩**

TCP/IP 네트워크에선 ARP 브로드캐스트를 미리 주고받은 후 데이터가 전달되기 때문에 플러딩하지 않는다. 스위치를 사용해 필요한 곳에만 포워드 하므로 주변 통신을 악의적으로 가로채기 힘들어 보안에 도움이 된다. 스위치에게 엉뚱한 MAC 주소를 습득시키거나 MAC 테이블을 꽉차게해 플러딩이 일어나도록 유도하는 공격도 있다.

### 2. 어드레스 러닝

MAC 주소 테이블을 만들고 유지하는 과정을 뜻한다. 패킷의 출발지 MAC 주소를 이용해 테이블에 기록한다.

어드레스 러닝은 출발지의 MAC 주소를 사용하므로 브로드캐스트나 멀티캐스트에 대한 MAC 주소를 학습할 수 없다.

**사전 정의된 MAC 테이블**

MAC 테이블엔 학습하기 전에 미리 정의된 정보가 있는데, 대부분 스위치간 통신을 위해 사용되는 주소값이다. `show mac address-table` 을 통해 확인할 수 있다.

### 3. 포워딩/필터링

패킷이 스위치에 들어온 경우 자신의 MAC 테이블과 비교해 매치되는 포트로 포워딩한다. 이때 다른 포트로 패킷을 전송하지 않는데 이를 필터링이라고 한다.

스위치는 포워딩/필터링을 통해 원하는 목적지로만 패킷을 전달되도록 동작한다.

언노운 유니캐스트, 브로드캐스트, 멀티캐스트는 출발지가 사용되지 않아 어드레스 러닝을 할 수 없어 모두 플러딩한다.

**LAN에서의 ARP - 스위치 동작**

TCP/IP 에선 스위치가 플러딩하는 경우가 거의 없다. 왜냐하면 통신해야하는 단말의 MAC을 알기위해 ARP 브로드캐스트를 먼저 전달하기 때문이다. 이때의 정보를 MAC 테이블에 저장하고 포워딩 한다.

# VLAN

물리적 배치와 상관없이 LAN을 논리적으로 분할, 구성하는 기술이다.

기업에서 부서별로 네트워크를 운영해야할 때 네트워크 분할을 하게 되는데, 과도한 브로드캐스트로 단말들의 성능저하, 보안 향상을 위한 차단 용도, 서비스 성격에 따른 정책 적용과 같은 이유로 네트워크를 분리한다.

VLAN으로 나뉜 네트워크는 유니캐스트, 브로드캐스트로 통신할 수 없으며, 3계층 장비를 통해 통신해야 한다.

### 종류와 특징

- 포트기반 VLAN
    
    스위치를 논리적으로 분할해 사용하는 방법. 일반적으로 사용되는 방법으로 어떤 단말에 접속하든지 스위치의 특정 포트에 VLAN을 할당하면 할당된 VLAN에 속하게 된다.
    
- MAC 기반 VLAN (다이나믹 VLAN)
    
    스위치의 고정 포트에 VLAN을 할당하는 것이 아니라 스위치에 연결되는 단말의 MAC 주소를 기반으로 VLAN을 할당하는 방법이다.
    

### VALN 모드 동작 방식 (포트 기반)

같은 스위치의 다른 VLAN은 별도의 스위치에 연결된 것과 같으므로 ARP 요청이 전달되지 않아 VLAN 간 통신이 불가능하다. 따라서 3계층 장비를 사용해야 한다. 

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/a61eb433-0b5e-4a07-8eb0-7ea21226feca)

여러개의 VLAN이 존재하는 상황에서 스위치를 서로 연결해야 하는 경우에는 각 VLAN끼리 통신하려면 VALN 개수만큼 포트를 연결해야한다. VLAN을 많이 사용하는 중형 이상의 네트워크에선 통신을 위한 포트만으로도 많은 포트가 낭비된다.

VLAN 태그 기능은 이 문제를 해결할 수 있다. (태그포트, 트렁크포트)

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/2bed8ae6-03fb-4bd7-9f67-d0b18d0aa6a7)

하나의 포트에 여러개의 VLAN을 함께 전송할 수 있게 해준다. 태그 포트는 이더넷 프레임 중간에 VLAN ID 필드를 끼워넣어 이 정보를 이용하는데, 보낼때 VLAN ID를 붙이고 수신측에서 제거하면서 VLAN으로 패킷을 보낼 수 있다.

태그 포트 기능이 스위치에 생기면서 스위치 패킷 전송에 사용되는 MAC 주소 테이블에도 변화가 생긴다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/6aacaf47-5d2a-423a-9ffc-85cfe7008324)

다른 VLAN과 통신하지 못하도록 MAC 테이블에 VLAN을 지정하는 필드가 추가된다.

**언태그 포트(엑세스 포트)**

일반적인 포트를 뜻하며 하나의 VLAN에 속한경우에만 사용된다. 패킷이 들어올 경우 같은 VLAN으로만 패킷을 전송한다.

**태그 포트**

여러 VLAN이 한번에 통신하도록 해주는 포트다. 패킷이 들어올 경우 태그를 벗겨내면서 태그된 VLAN으로 패킷을 전송한다.
