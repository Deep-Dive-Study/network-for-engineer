# 4.3 STP

IT 환경에서 SPoF로 인한 장애를 피하기 위해 다양한 노력을 한다. 네트워크에서도 하나의 장비 고장으로 전체 네트워크가 마비되는 것을 막기 위해 N중화 네트워크를 디자인하고 구성한다.

* SPoF : 하나의 시스템 또는 구성 요소에서 고장이 발생했을 때 전체 시스템의 작동이 멈추는 요소

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/0321f845-27f9-46db-91f8-c7dbce827bdf)

이런 SPoF를 피하기 위해 위와 같이 스위치를 두 대 구성하면 패킷이 네트워크를 따라 계속 전송(네트워크 루프) 되므로 네트워크를 마비시킬 수 있다. 루프를 예방하기 위해 별도의 매커니즘이 필요한데 어떤 방법이 있는지 알아보자

### 루프

단일 고리 또는 중복 고리 같은 형태로 네트워크에 연결된 모양이 되돌아오는 형태를 뜻한다. 네트워크 문제를 정확히 인지하는 경우는 드물지만 대부분은 브로드캐스트 스톰으로 생기는 문제이다.

- 브로드캐스트 스톰
    
    네트워크가 연결된 상태에서 브로드캐스트를 발생시키면 스위치는 유입된 포트를 제외한 모든 포트로 플러딩 한다. 루프 구조인 경우 이 패킷이 계속 돌아가는데 이를 뜻한다.
    
    3계층 헤더에는 TTL이 있어 패킷의 수명이 있지만, 2계층 헤더에는 TTL같은 라이프타임 매커니즘이 존재하지 않아 패킷이 죽지 않고 계속 돌게 된다. 
    
    브로드캐스트 스톰 증상
    
    1. 네트워크에 접속된 단말의 속도가 느려진다. CPU 사용량 증가
    2. 네트워크 접속 속도가 느려진다. (거의 통신 불가능)
    3. 네트워크에 설치된 스위치에 모든 LED들이 동시에 빠른 속도로 깜빡인다.

- 스위치 MAC 러닝 중복 문제
    
    루프 구조 상태에선 브로드캐스트 뿐만 아니라 유니캐스트도 문제를 일으킨다.
    
    스위치는 출발지의 MAC 주소를 학습하는데 직접 전달되는 패킷과 스위치를 돌아 들어간 패킷 간의 포트가 달라 MAC 주소 학습이 정상적으로 이루어지지 않는다.  이를 MAC 어드레스 플래핑이라고 한다.
    
    이런 현상을 예방하기 위해 스위치 설정에 따라 경고 메세지를 관리자에게 보내거나, 플래핑 현상을 학습하지 않도록 조치한다.
    

네트워크 루프가 발생한 경우 위에서 설명한 장애가 생기기 떄문에 루프 구성 포트중 하나의 포트만 사용하지 못하도록 셧다운해도 루프를 예방할 수 있다. 하지만 이 방법은 스위치를 두 개 이상 디자인한 의미가 퇴색되기 때문에 이 방법은 바람직하지 않다. 루프를 찾아내기 어려울 뿐더러 장애가 발생하면 수동으로 포트를 살려야 한다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/3bf4290d-9700-4194-aa62-83376562bac5)

여러가지 이유로  루프 자동으로 감지하고 포트를 차단하고 장애 때문에 우회로가 없을 때 차단된 포트를 스위치 스스로 살리는 스패닝 트리 프로토콜이 개발되었다.

### STP(Spanning Tree Protocol)

루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 매커니즘이다.

STP를 사용해 루프를 예방하려면 전체 스위치가 어떻게 연결되는지 알아야 한다.  전체적인 스위치 연결 상황을 파악하려면 스위치 간에 정보를 전달해야 하는데, 이를 위해 스위치는 BPDU라는 프로토콜을 통해 스위치간 정보를 전달하고, 루프 구간을 확인한다.

![image](https://github.com/Deep-Dive-Study/network-for-engineer/assets/85796588/cdbc80eb-60c4-4631-8c39-161b82bf85ba)

BPDU에는 스위치가 갖고 있는 ID와 같은 고유값이 들어가고 이런 정보를 스위치 간에 서로 교환하면서 루프 파악을 한다.  이렇게 확인된 루프 지점을 데이터 트래픽이 통과하지 못하도록 차단해 루프를 예방한다.

**스위치 포트의 상태 및 변경 과정**

STP가 동작중인 스위치에서는 루프를 막기 위해 신규 스위치가 연결되면 바로 트래픽이 흐르지 않도록 차단한다. 그리고 4가지 상태를 거쳐 포워딩 된다.

1. Blocking
    
    패킷 데이터를 차단한 상태로 상대방이 보내는 BPDU를 기다린다.
    
    Max Age(20초)동안 BPDU를 받지 못하거나 후순위 BPDU를 받는 경우 Listening 상태로 변경된다. BPDU 교환 주기는 2초기 때문에 총 10번의 기다린다.
    
2. Listening
    
    해당 포트가 전송 상태로 변경되는 것을 결정하고 준비하는 단계이다.  이때부터 자신의 BPDU 정보를 상대방에게 전송한다. 총 15초 동안 대기한다.
    
3. Learning
    
    해당 포트를 포워딩하기로 결정하고 실제로 패킷 포워딩이 일어날 때 스위치가 곧바로 동작하도록 MAC 주소를 러닝하는 단계. 총 15초 동안 대기한다.
    
4. Forwarding
    
    패킷을 포워딩하는 단계로 정상적으로 통신한다.
    

다음과 같은 단계를 거치기 때문에 스위치에 신규 장비를 붙이면 통신하는데 50초가 소요된다.  스위치는 루프를 예방하기 위해 매우 방어적으로 동작하기 때문에 새로운 장비가 스위치가 아니어도 동일한 시간이 필요하다.

이중화된 링크 절체도 STP 동작 순서대로 진행되는데,  다운된 링크가 자신의 인터페이스인 경우 토폴로지가 직접 감지할 수 있어 즉시 Listening 상태가 되어서 30초만에 절체된다.

시간 지연이 문제가 된다면 포트 패스트로 설정하여 BPDU 대기, 습득 과정 없이 곧바로 포워딩 상태로 사용할 수 있다. 이는 루프가 생길 위험이 있어 BPDU 가드같은 기술이 함께 사용되어야 한다.

**STP 동작 방식**

1. 전체 네트워크에 하나의 루트 스위치를 선정한다.
2. 자신을 대표 스위치로 적은 BPDU를 옆 스위치로 전달한다.
3. 루트가 아닌 스위치 중 하나의 루트 포트를 선정한다. (루트 브릿지로 가는 경로가 가장 짧은 포트,  루트 브릿지에서 보낸 BPDU를 받는 포트)
4. 하나의 세그먼트에 하나의 지정 포트를 선정한다.
    1. 스위치와 스위치가 연결되는 포트는 하나의 지정 포트를 선정한다.
    2. 스위치 간 연결에서 이미 루트 포트로 선정된 경우 반대쪽이 지정포트로 선정되어 포워딩된다.
    3. 아무도 루트 포트가 아닌 경우 한쪽은 지정포트, 다른 한쪽은 대체 포트가 되어 차단상태가 된다.

### 향상된 STP(RSTP, MST)

STP는 네트워크에 속한 모든 스위치까지 BPDU가 전달되는 시간을 고려해 30~50초의 시간이 소요된다. 가장 많이 쓰이는 TCP 기반 애플리케이션이 네트워크가 끊겼을 때 30초를 기다리지 못하니 장애가 발생하면 통신이 끊기기도 하고, 스위치에 여러개의 VLAN이 있으면 각 VLAN별로 STP를 계산하며 부하가 발생하기도 하는데 향상된 STP가 해결해준다.

**RSTP**

STP가 활성화 되기까지의 시간이 오래걸려 개발되었다. 2~3초의 절체 시간이 있어 일반적인 TCP 통신이 세션을 유지할 수 있게 한다.

기본적인 구성은 STP와 같지만, BPDU 형식이 다양해져 여러 가지 상태 메시지를 교환할 수 있다. STP는 2가지 메시지가 있지만 RSTP는 8개의 비트를 활용해 다양한 정보를 주고 받는다. 또한 토폴로지 변경 전파를 직접 할 수 있어졌다. 그렇기 때문에 RSTP는 2~3초 만에 장애 복구가 가능해 애플리케이션 세션이 끊기지 않는다.

**MST**

- CST(Common Spanning Tree)
    
     VLAN 개수와 상관없이 한 개만 동작하게 된다. 이 경우 VLAN이 많더라도 스위치에 부하는 적은 대신 자원을 효율적으로 활용할 수 없다는 단점이 있다.
    
    일반 STP가 CST에 해당된다.
    
- PVST(Per Vlan Spanning Tree)
    
    VLAN 마다 다른 STP를 동작시켜 최적의 경로를 디자인한다.
    
    별도의 블록 포트를 지정해 네트워크 로드를 셰어링 하도록 구성한다.
    
    스위치에 많은 부담이 된다.
    
- MST(Multiple Spanning Tree)
    
    여러개의 VLAN을 그룹으로 묶어 각 그룹마다 STP가 동작된다. PVST의 장점을 가져오며 단점을 상쇄했다.
    
    일반적으로 VLAN을 하나의 리전으로 묶어 관리한다.
    

* STP의 대안

STP를 근본적으로 대체하기 위해 사용되는 프로토콜이 많다.

- SLPP (Nortel사의 루프 예방 프로토콜)
- Extreme STP (Extreme사의 루프 예방 프로토콜)
- Loop Guard (STP와 다른 매커니즘)
- BPDU Guard (BPDU가 인입될 경우, 해당 포트 차단)
